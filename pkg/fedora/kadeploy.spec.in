Name:           kadeploy
Version:        MAJOR_VERSION.MINOR_VERSION
Release:        RELEASE_VERSION
Group:          System/Cluster
License:        CeCILL V2
URL:            http://gforge.inria.fr/scm/?group_id=2026
Source0:        %{name}-%{version}.%{release}.tar.gz
BuildRoot:      %{_tmppath}/%{name}-%{version}.%{release}-root-%(%{__id_u} -n)
BuildArch:      noarch
Summary:        Package of the Kadeploy deployment tool.

%description
Kadeploy 3 is the next generation of the fast and scalable deployment system
for cluster and grid computing. Kadeploy is the reconfiguration system used 
in Grid5000, allowing the users to deploy their own OS on their reserved nodes.

%package common
Summary:        Common part of the Kadeploy deployment tool.
Requires:       ruby, ruby-mysql, ruby-libs
Group:          System/Cluster
%description common
This package provide the common part of the Kadeploy deployment tool.

%package server
Summary:        Server part of the Kadeploy deployment tool.
Requires:       ruby, ruby-mysql, kadeploy-common = %{version}, taktuk >= 3.6
Group:          System/Cluster
%description server
This package provide the server part of the Kadeploy deployment tool.

%package client
Summary:        Client part of the Kadeploy deployment tool.
Requires:       ruby, ruby-mysql, kadeploy-common = %{version}
Group:          System/Cluster
%description client
This package provide the client part of the Kadeploy deployment tool.

%prep
%setup -q

%build

%install
rm -rf $RPM_BUILD_ROOT
make install_all DESTDIR=$RPM_BUILD_ROOT DISTRIB=fedora

%check

%clean
rm -rf $RPM_BUILD_ROOT

%files common
%defattr(-,deploy,deploy,-)
%doc License.txt
/usr/local/kadeploy3
%dir /etc/kadeploy3
/etc/kadeploy3/load_kadeploy_env
%doc %attr(0444,root,root) /usr/local/man/man1/kadeploy3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kareboot3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kaenv3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kastat3.1
%doc %attr(0444,root,root) /usr/local/man/man1/karights3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kanodes3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kaconsole3.1
%doc %attr(0444,root,root) /usr/local/man/man1/kapower3.1
%doc %attr(0444,root,root) /usr/local/kadeploy3/scripts/bootloader/install_grub
%doc %attr(0444,root,root) /usr/local/kadeploy3/scripts/bootloader/install_grub2
%doc %attr(0444,root,root) /usr/local/kadeploy3/scripts/partitioning/parted-sample
%doc %attr(0444,root,root) /usr/local/kadeploy3/scripts/partitioning/fdisk-sample

%files server
%defattr(-,deploy,deploy,-)
%dir /var/log/kadeploy
/etc/init.d/kadeploy3d
%config(noreplace) /etc/kadeploy3/clusters.yml
%config(noreplace) /etc/kadeploy3/cluster_conf-g5kdev-cluster.yml
%config(noreplace) /etc/kadeploy3/cmd.yml
%config(noreplace) /etc/kadeploy3/server_conf.yml
%config(noreplace) /etc/kadeploy3/install_grub
%config(noreplace) /etc/kadeploy3/install_grub2
%config(noreplace) /etc/kadeploy3/parted-sample
%config(noreplace) /etc/kadeploy3/fdisk-sample
/etc/kadeploy3/version
/etc/kadeploy3/keys/id_deploy
/etc/kadeploy3/keys/id_deploy.pub
/usr/bin/kastafior
/usr/sbin/kadeploy3d


%files client
%defattr(-,deploy,deploy,-)
%config(noreplace) /etc/kadeploy3/client_conf.yml
/usr/bin/kaconsole3
/usr/bin/kanodes3
/usr/bin/kastat3
/usr/bin/kadeploy3
/usr/bin/kaenv3
/usr/bin/kareboot3
/usr/bin/kapower3
/usr/sbin/karights3

%pre common
if ! getent passwd deploy >/dev/null 2>&1 ; then
  /usr/sbin/useradd -d /home/deploy deploy >/dev/null 2>&1 || exit 1
fi

%post server
chkconfig --add kadeploy3d

%preun server
chkconfig --del kadeploy3d
