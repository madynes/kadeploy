\documentclass[a4wide,10pt,oneside]{book}
\usepackage{ucs}
\usepackage[utf8x]{inputenc}
\usepackage[T1]{fontenc}
\usepackage{graphicx}
\usepackage{hyperref}
\usepackage{fancyvrb}
\usepackage{alltt}
\renewcommand{\ttdefault}{txtt}

\newcommand{\version}{3.1.5}

\newcommand{\ypath}[1]{\texttt{#1}}
\newcommand{\yfield}[2]{\texttt{#1} {\small\{{\emph{#2}}\}}:}
\newcommand{\yfieldd}[3]{\texttt{#1} {\small\{{\emph{#2}}\}} {\small(}#3{\small)}:}

\addtolength{\hoffset}{-1.5cm}
\addtolength{\textwidth}{3cm}
\sloppy
\title{Kadeploy 3: Installation, configuration and use}
\begin{document}
\maketitle

\vspace*{18cm}
\noindent Copyright \copyright by Inria, 2008-2012\\
KADEPLOY \version, CECILL 2.0 license, All rights reserved.

\tableofcontents

\chapter{Installation}
\section{Requirements}
\subsection{Packages}\label{sec:required-packages}
Kadeploy requires the following softwares (the Debian packages available in the Lenny flavor are given):
\begin{itemize}
\item \texttt{ruby1.8}
\item \texttt{mysql-ruby1.8}
\item \texttt{bittorrent}
\item \texttt{ctorrent}
\item \texttt{taktuk >= 3.6}
\end{itemize}

\subsection{DHCP and TFTP}
A DHCP server (\texttt{dhcp3-server} on Debian for instance) must be configured to provide a static IP address to the set of nodes that must be deployed. Furthermore, the DHCP response must contains the hostname of the node (see the \texttt{use-host-decl-names on;} option in \texttt{dhcpd.conf}).

A TFTP server (\texttt{tftpd-hpa} on Debian for instance) must be installed.

To allow the network booting, you must specify in the DHCP configuration file the file name option that define the file retrieve by a client. This file name can be pxelinux.0 or gpxelinux.0.

Finally, the TFTP repository (see~\ref{sec:general_config} part) must contain the following files: pxelinux.0 (or gpxelinux.0), chain.c32, and mboot.c32. These files can be found in the Syslinux software (\url{http://syslinux.zytor.com}), the 3.73 version is at least required.

\subsection{HTTP server (optional)}
In order to use the HTTP fetching capabilities of gpxelinux, an HTTP server must be configured and must contain the production environment kernel/initrtd and the deployment environment kernel/initrd (see~\ref{sec:specific_config} part).

\subsection{MySql}
A MySql server must be configured with a database and a user dedicated to Kadeploy. The rights on this database must be granted to the chosen user, from the Kadeploy server. The server used to host the database, the database name, the dedicated user and its password must be specified in the general Kadeploy configuration (see~\ref{sec:general_config} part).

Just provided as an example, let's see a way to create the database \texttt{deploy3} and to give the suitable rights to the \texttt{deploy} user.
\begin{verbatim}
mysql> CREATE DATABASE deploy3;
mysql> GRANT select, insert, update, delete, create, drop, alter, \
             create temporary tables, lock tables ON deploy3.* \
             TO 'deploy'@'frontale.site.grid5000.fr';
\end{verbatim}

Once the database is created and the user granted, you can use the SQL script provided in the distribution (\texttt{db/db\_creation.sql}) to create the tables in the database.

\section{Kadeploy installation}
Since Kadeploy is based on a client/server architecture, you must perform the install on both the server and the client if it is not the same machine.

Two ways are provided to install Kadeploy, a basic installer and packages (for Debian and Fedora). In both cases, you had to ensure that a user \texttt{deploy} is existing on your system. This user is used to execute the Kadeploy server. Furthermore, all the installation operations must be performed with root rights.

\subsection{Basic installation}
First of all , you have to uncompress the Kadeploy tarball.
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> tar xzf kadeploy-\version.tar.gz -C DESTINATION_DIR
\end{Verbatim}
\end{small}

\noindent Then, if you want to install the server part, just execute:
\begin{small}
\begin{verbatim}
> make install_common
> make install_server
\end{verbatim}
\end{small}

\noindent If you want to install the client part, execute:
\begin{small}
\begin{verbatim}
> make install_common
> make install_client
\end{verbatim}
\end{small}

\noindent If you want to install the server part and the client part on the same host, execute:
\begin{small}
\begin{verbatim}
> make install_all
\end{verbatim}
\end{small}

\noindent If you want to install the rc script, you can add the \texttt{DISTRIB} flag. Currently, only Debian (it includes Ubuntu at least) and Fedora (it should include CentOS and RHEL) values are supported. For instance, you cans execute:
\begin{small}
\begin{verbatim}
> make install_all DISTRIB=fedora
\end{verbatim}
\end{small}
or if you do not install the server side on the same machine than the client side:
\begin{small}
\begin{verbatim}
> make install_server DISTRIB=fedora
\end{verbatim}
\end{small}

\noindent In order to preserve a previous configuration, the configuration directory \texttt{/etc/kadeploy3} is saved, if existing, to a directory named \texttt{/etc/kadeploy3-save-TIMESTAMP} where \texttt{TIMESTAMP} is the moment of the new installation launch.

\noindent Finally, Kadeploy can be simply uninstalled by executing:
\begin{small}
\begin{verbatim}
> make uninstall
\end{verbatim}
\end{small}

\noindent In case of uninstallation, the configuration directory \texttt{/etc/kadeploy3} is not removed.

\subsection{Debian packages}
The following installation method works only an Debian based distribution.
\subsubsection{Build}
\noindent First, you have to uncompress the Kadeploy tarball. 
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> tar xzf kadeploy-\version.tar.gz -C DESTINATION_DIR
\end{Verbatim}
\end{small}

\noindent Then you must generate the packages. So you have to execute:
\begin{small}
\begin{verbatim}
> make deb
\end{verbatim}
\end{small}
This will generate three Debian package: \texttt{kadeploy-common-\version.deb}, \texttt{kadeploy-client-\version.deb}, and \texttt{kadeploy-server-\version.deb}.
\subsubsection{Installation}
\noindent On the server side, you have to install the \texttt{kadeploy-common-\version.deb} and \texttt{kadeploy-server-\version.deb} packages.
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> dpkg -i kadeploy-common-\version.deb
> dpkg -i kadeploy-server-\version.deb
\end{Verbatim}
\end{small}

\noindent On the client side, you have to install the \texttt{kadeploy-common-\version.deb} and \texttt{kadeploy-client-\version.deb} packages.
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> dpkg -i kadeploy-common-\version.deb
> dpkg -i kadeploy-client-\version.deb
\end{Verbatim}
\end{small}

\noindent In the want to use the same host for the client and the server part, just install the three packages:
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> dpkg -i kadeploy-common-\version.deb
> dpkg -i kadeploy-client-\version.deb
> dpkg -i kadeploy-server-\version.deb
\end{Verbatim}
\end{small}

\paragraph{Warning}
In order to preserve your configuration files, the removal of a Kadeploy package will preserve the configuration files (unless you specify the \texttt{--purge} tag).

\subsection{Fedora packages}
The following installation method works only an Fedora based distribution. We assume that you have a configured rpm build environment. Furthermore, Taktuk must be installed on the server side.
\subsubsection{Build}
\noindent First, you have to uncompress the Kadeploy tarball. 
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> tar xzf kadeploy-\version.tar.gz -C DESTINATION_DIR
\end{Verbatim}
\end{small}

\noindent Then you must generate the packages. So you have to execute with root rights:
\begin{small}
\begin{verbatim}
> make rpm
\end{verbatim}
\end{small}
This will generate three rpm package in the RPMS package of your build environment, for instance: \texttt{kadeploy-client-\version.noarch.rpm}, \texttt{kadeploy-server-\version.noarch.rpm}, and \texttt{kadeploy-common-\version.noarch.rpm}.
\subsubsection{Installation}
\noindent On the server side, you have to install the \texttt{kadeploy-common-\version.noarch.rpm} and \texttt{kadeploy-server-\version.noarch.rpm} packages.
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> rpm -i kadeploy-common-\version.noarch.rpm
> rpm -i kadeploy-server-\version.noarch.rpm
\end{Verbatim}
\end{small}

\noindent On the client side, you have to install the \texttt{kadeploy-common-\version.noarch.rpm} and \texttt{kadeploy-client-\version.noarch.rpm} packages.
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> rpm -i kadeploy-common-\version.noarch.rpm
> rpm -i kadeploy-client-\version.noarch.rpm
\end{Verbatim}
\end{small}

\noindent In the want to use the same host for the client and the server part, just install the three packages:
\begin{small}
\begin{Verbatim}[commandchars=\\\{\}]
> rpm -i kadeploy-common-\version.noarch.rpm
> rpm -i kadeploy-server-\version.noarch.rpm
> rpm -i kadeploy-client-\version.noarch.rpm
\end{Verbatim}
\end{small}


\section{Launching the Kadeploy server}
After being installed and configured, the Kadeploy server can be run either interactively:
\begin{small}
\begin{verbatim}
> /usr/sbin/kadeploy3d
\end{verbatim}
\end{small}
\noindent or in background using the rc script:
\begin{small}
\begin{verbatim}
> /etc/init.d/kadeploy3d start
\end{verbatim}
\end{small}

\subsection{Automatic launch on a Debian and a Fedora based distribution}
\noindent On a these distributions, if you use the provided packages, the rc script will be automatically launched at the startup.

\chapter{Server side configuration}
\paragraph{Configuration files\\}
Normally, the configuration of Kadeploy is located in \texttt{/etc/kadeploy3} but it can be located anywhere else if you set the \texttt{KADEPLOY\_CONFIG\_DIR} variable in the environment.

The file \texttt{load\_kadeploy\_env} in the configuration directory contains the \texttt{KADEPLOY\_INSTALL\_DIR} variable. You should probably fill this variable with the Kadeploy installation directory you used. This directory can be anywhere in the filesystem.

\paragraph{Description format: YAML\\}\label{sec:yamlconf}
In Kadeploy configuration settings are given using the YAML markup language. You should be aware that, in this language, indentation is very important. Also, in the YAML language, fields are typed, the value \texttt{"16"} is not equivalent to the value \texttt{16}.

\paragraph{YAML types\\}
In Kadeploy configuration files, values can have the YAML data types: \emph{Integer}, \emph{Float}, \emph{Boolean} and \emph{String}.

YAML provides a way to describe hierarchy between elements using \emph{Associative arrays} (\texttt{key} $\to$ \texttt{value}) and \emph{Ordered lists}. It's possible to mix this structures.

Here are some examples:
\begin{small}
\begin{alltt}
--- 
sample-array:{\footnotesize # This is an Associative array containing 3} elements
  elem1: 8{\footnotesize # Integer}
  elem2: "8"{\footnotesize # String}
  elem3:\textbf{\footnotesize vREF1}
sample-list:{\footnotesize # This is an Ordered list of 2 elements}
  - true{\footnotesize # Boolean}
  - "true"{\footnotesize # String}
sample-mix-1:{\footnotesize # An Ordered list of identical Associative arrays}
  - elem1: value1{\footnotesize # String}
    elem2:\textbf{\footnotesize vREF2}
  - elem1: value2{\footnotesize # String}
    elem2:\textbf{\footnotesize vREF3}
sample-mix-2:{\footnotesize # An Associative array of Ordered lists}
  elem1:
    - 1.42{\footnotesize # Float}
    - value1
  elem2:
    - value2
    - value3
sample-complex:{\footnotesize # Complex structure}
  mylist:
    - size: 16
      name:\textbf{\footnotesize vREF4}
    - size: 32
      name:\textbf{\footnotesize vREF5}
  value: myval
  mysample:
    file: filename
    ext: ext
    mode:\textbf{\footnotesize vREF6}
\end{alltt}
\end{small}

\paragraph{Documentation: paths\\}
Kadeploy configuration settings will be described by giving a \emph{path} to each resources. A \emph{path} explicit the hierarchy structure to follow to spefify a setting in the configuration file. In a \emph{path}, the character \texttt{/} describes a nested \emph{Associative array}, characters \texttt{$[...]$} describes an \emph{Ordered list} of identical \emph{Associative arrays}.\\

Sample of \emph{path}s in our sample:
\begin{itemize}
  \item \texttt{\small /sample-array/elem3} refers to the value \texttt{\small vREF1};
  \item \texttt{\small /$[$sample-mix-1$]$/elem2} refers to values such as \texttt{\small vREF2} and \texttt{\small vREF3};
  \item \texttt{\small /sample-complex/$[$mylist$]$} refers to the \emph{Ordered List} \texttt{\small mylist};
  \item \texttt{\small /sample-complex/$[$mylist$]$/name} refers to values such as \texttt{\small vREF4} and \texttt{\small vREF5};
  \item \texttt{\small /sample-complex/mysample/mode} refers to value \texttt{\small vREF5}.
\end{itemize}

\paragraph{Documentation: configuration files fields\\}
In the following, fields descriptions are given using the formalism:
\begin{itemize}
  \item \ypath{/path/to/the/field}
  \begin{itemize}
    \item \yfieldd{fieldname}{YAML type}{default value} description of the field
  \end{itemize}
\end{itemize}
If no default value is specified, the field is mandatory.

Sample of field description:
\begin{itemize}
  \item \ypath{/sample-complex}
  \begin{itemize}
    \item \yfield{myvalue}{String} the value of the element
  \end{itemize}
  \item \ypath{/sample-complex/mysample}
  \begin{itemize}
    \item \yfieldd{file}{String}{sample} the name of the sample file
    \item \yfieldd{ext}{String}{txt} the extension of the sample file
  \end{itemize}
  \item \ypath{/sample-complex/[mylist]}
  \begin{itemize}
    \item \yfield{name}{String} the name of the element
    \item \yfieldd{size}{Integer}{8} the maximal size (MB) of the element
  \end{itemize}
\end{itemize}

\section{General configuration file}\label{sec:general_config}
The general configuration file is named \texttt{server\_conf.yml} and is located in the Kadeploy configuration directory.

\subsection{Example of a general configuration file}
\begin{small}
\begin{verbatim}
--- 
database:
  host: mysql.lan
  name: deploy3
  login: deploy_user
  passwd: deploy_password
  kind: mysql
rights:
  kind: db
  almighty_users: root,superuser
  purge_deployment_timer: 900
logs:
  file: /tmp/kadeploy.log
  syslog: true
  database: true
  debug: true
verbosity:
  clients: 3
  logs: 4
cache:
  directory: /var/cache/kadeploy
  size: /tmp/kadeploy_cache
  disabled: false
network:
  server_hostname: kadeploy.lan
  vlan:
    set_cmd: kavlan NODES -s -i VLAN_ID -u USER
    hostname_suffix: -kavlan-VLAN_ID
  ports: 
    ssh: 22
    kadeploy_server: 25300
    test_deploy_env: 25300
  tcp_buffer_size: 8192
windows: 
  check: 
    size: 90
  reboot: 
    size: 100
    sleep_time: 10
environments: 
  deployment: 
    extraction_dir: /mnt/dest
    tarball_dir: /tmp
    rambin_dir: /rambin
  max_postinstall_size: 10
  max_preinstall_size: 10
pxe:
  kind: PXElinux
  repository: /var/lib/tftpboot/
  export: /
  kernels:
    directory: kernels
    max_size: 4000
  bootloader: chainload_pxe
hooks: 
  async: 
    end_of_reboot: echo REBOOT_ID
    end_of_power: echo POWER_ID
    end_of_deployment: echo WORKFLOW_ID
external:
  taktuk: 
    auto_propagate: false
    connector: |-
      ssh -q -o StrictHostKeyChecking=no \
      -o UserKnownHostsFile=/dev/null \
      -o PreferredAuthentications=publickey \
      -o BatchMode=yes -i /etc/kadeploy3/keys/id_deploy
    tree_arity: 0
  bittorrent: 
    tracker_ip: 10.0.0.4
    download_timeout: 1800
  grub:
    version: 2
  mkfs:
  - fstype: ext2
    args: -b 4096 -O sparse_super,filetype,resize_inode,dir_index
  - fstype: ext3
    args: -b 4096 -O sparse_super,filetype,resize_inode,dir_index
  kastafior:
    binary: /usr/bin/kastafior
\end{verbatim}
\end{small}

\subsection{Explanation of the fields used in the general configuration file}
\begin{itemize}
  \item \ypath{/database}
  \begin{itemize}
    \item \yfield{host}{String} hostname of the database
    \item \yfield{name}{String} name of the Kadeploy database
    \item \yfield{login}{String} login for the Kadeploy database
    \item \yfield{passwd}{String} password for the Kadeploy database
    \item \yfield{kind}{String} database kind (only mysql is available now).
  \end{itemize}

  \item \ypath{/rights}
  \begin{itemize}
    \item \yfieldd{kind}{String}{db} authentication kind (use db for a true rights management or dummy to bypass the rights management)
    \item \yfieldd{almighty\_users}{String}{root} list of users allowed to perform special operations on the environments like publishing environments or moving files
    \item \yfieldd{purge\_deployment\_timer}{Integer}{900} limeout used to consider that a deployment is finished. This is used to avoid several deployment on the same nodes at the same time.
  \end{itemize}

  \item \ypath{/logs}
  \begin{itemize}
    \item \yfieldd{file}{String}{/var/log/kadeploy.log} absolute path of a file that will contain the log information. If you do not wish to use a log file, leave this field empty.
    \item \yfieldd{syslog}{Boolean}{true} use Syslog to export the log information (expected values are true or false). The Syslog tag is ``Kadeploy-log''.
    \item \yfieldd{database}{Boolean}{true} use the Kadeploy database to export the log information
    \item \yfieldd{debug}{Boolean}{false} use Syslog to export the debug information (expected values are true or false). The Syslog tag is ``Kadeploy-dbg''.
  \end{itemize}

  \item \ypath{/verbosity}
  \begin{itemize}
    \item \yfieldd{clients}{Integer}{3} number between 0 and 5 that specifies the default verbose level for the client. 0 means ``no verbose'' and 5 means ``full verbose''.
    \item \yfieldd{logs}{Integer}{3} debug level of the output exported to Syslog.
  \end{itemize}

  \item \ypath{/cache}
  \begin{itemize}
    \item \yfieldd{directory}{String}{/tmp} absolute path of the Kadeploy cache. The cache dir is used to store the files of a user in a deployment
    \item \yfield{size}{Integer} size (MB) of the Kadeploy cache.
    \item \yfieldd{disable}{boolean}{false} disable the use of a cache
  \end{itemize}

  \item \ypath{/network}
  \begin{itemize}
    \item \yfield{server\_hostname}{String} hostname of the Kadeploy server
    \item \yfieldd{tcp\_buffer\_size}{Integer}{8192} TCP buffer size (Bytes) for the Kadeploy file server
  \end{itemize}

  \item \ypath{/network/vlan}
  \begin{itemize}
    \item \yfieldd{hostname\_suffix}{String}{''} this specifies the suffix to add to the hostname to define the hostname in the given VLAN. The pattern VLAN\_ID can be used in the definition, it is replaced at the runtime.
    \item \yfieldd{set\_cmd}{String}{''} command to launch in order to put a set of nodes in a VLAN. The patterns NODES, USER and VLAN\_ID can be used.
  \end{itemize}

  \item \ypath{/network/ports}
  \begin{itemize}
    \item \yfieldd{ssh}{Integer}{22} port used by SSH
    \item \yfieldd{kadeploy\_server}{Integer}{25300} port of the Kadeploy server
    \item \yfieldd{test\_deploy\_env}{Integer}{25300} port used as a tag in the deployment environment to ensure that the deployment environment is successfully booted
  \end{itemize}

  \item \ypath{/windows/check}
  \begin{itemize}
    \item \yfieldd{size}{Integer}{22} size of the nodes check window.
  \end{itemize}

  \item \ypath{/windows/reboot}
  \begin{itemize}
    \item \yfieldd{size}{Integer}{50} global size of the reboot window (ie. maximum number of nodes able to reboot at the same time). This might be useful to avoid high electricity peak.
    \item \yfieldd{sleep\_time}{Integer}{10} time to wait if the reboot window is full
  \end{itemize}

  \item \ypath{/environments}
  \begin{itemize}
    \item \yfieldd{max\_preinstall\_size}{Integer}{20} maximum size (MB) of the preinstall files
    \item \yfieldd{max\_postinstall\_size}{Integer}{20} maximum size (MB) of the postinstall files
  \end{itemize}

  \item \ypath{/environments/deployment}
  \begin{itemize}
    \item \yfieldd{extraction\_dir}{String}{/mnt/dest} extraction directory for the tarball in the deployment environment
    \item \yfieldd{tarball\_dir}{String}{/tmp} destination directory for the tarball download in the deployment environment. This is used when the tarballs are sent with Bittorrent.
    \item \yfieldd{rambin\_dir}{String}{/rambin} path of the ramdisk directory in the deployment environment
  \end{itemize}

  \item \ypath{/pxe}
  \begin{itemize}
    \item \yfieldd{kind}{String}{PXElinux} the PXE method used to boot over the network (expected values are PXElinux, GPXElinux or IPXE)
    \item \yfield{repository}{String} absolute path of the repository where PXE profiles are accessibles (TFTP, HTTP, ...). This path should not include the 'pxelinux.cfg' directory, Kadeploy find it automatically. Warning, as far as the Kadeploy server is launched by the \texttt{deploy} user, \texttt{deploy} must have the rights to write in this directory.
    \item \yfieldd{export}{String}{/} the root path to be used in pxe profiles. If the service used to serve PXE profiles is TFTP, it should be '/', if the service is HTTP, 'http://domain.tld/' or 'http://IP\_ADDR/'.
    \item \yfieldd{bootloader}{String}{chainload\_pxe} kind of bootloader used to boot the deployed nodes (expected values are chainload\_pxe and pure\_pxe)
  \end{itemize}

  \item \ypath{/pxe/kernels}
  \begin{itemize}
    \item \yfield{directory}{String} relative path of the PXE kernels sub-repository
    \item \yfield{max\_size}{Integer} maximal size (MB) of the PXE kernels sub-repository
  \end{itemize}

  \item \ypath{/hooks/async}
  \begin{itemize}
    \item \yfieldd{end\_of\_reboot}{String}{''} command to launch at the end of an asynchronous reboot. The REBOOT\_ID can be used in the command, it is replaced at the runtime.
    \item \yfieldd{end\_of\_power}{String}{''} command to launch at the end of an asynchronous power operation. The POWER\_ID can be used in the command, it is replaced at the runtime.
    \item \yfieldd{end\_of\_deployment}{String}{''} command to launch at the end of an asynchronous deployment. The WORKFLOW\_ID can be used in the command, it is replaced at the runtime.
  \end{itemize}

  \item \ypath{/external/taktuk}
  \begin{itemize}
    \item \yfield{connector}{String} connector used by Taktuk
    \item \yfieldd{tree\_arity}{Integer}{0} Taktuk tree arity for command executed through a tree. Use 0 if you want to use the work stealing algorithm of Taktuk and thus a dynamic tree arity. Use another value >0 to specify a static tree arity (should be avoided).
    \item \yfieldd{auto\_propagate}{Boolean}{true} use of the auto propagation feature of Taktuk. You should use this feature if the deployment environment doesn't contain Taktuk.
  \end{itemize}

  \item \ypath{/external/bittorrent}
  \begin{itemize}
    \item \yfieldd{tracker\_ip}{String}{nil} ip of the Bittorrent tracker
    \item \yfieldd{download\_timeout}{Integer}{nil} timeout for the Bittorrent file download
  \end{itemize}

  \item \ypath{/external/grub}
  \begin{itemize}
    \item \yfieldd{version}{Integer}{2} the version of grub to be installed on the partition of the deployed environment
  \end{itemize}

  \item \ypath{/external/[mkfs]} Options for mkfs. The options for several FS can be defined here.
  \begin{itemize}
    \item \yfieldd{fstype}{String}{nil} the filesystem type
    \item \yfieldd{args}{String}{nil} the specific options for this filesystem type
  \end{itemize}

  \item \ypath{/external/kastafior}
  \begin{itemize}
    \item \yfieldd{binary}{String}{kastafior} the command used to launch kastafior
  \end{itemize}
\end{itemize}


\section{Clusters file}
This file describes the list of all the clusters, the location of their specific setting files and their nodes. All the nodes of the clusters that aim to be deployed must be declared in this file. It must be defined in the  \texttt{/etc/kadeploy3/clusters.yml} file.

Warning, a cluster-specific configuration file and a partition file must be defined for each cluster define in this file.

\subsection{Example of a clusters file\\}
\begin{small}
\begin{verbatim}
--- 
clusters:
- name: graphene
  prefix: gra
  conf_file: cluster_conf-graphene.yml
  partition_file: cluster_partition-graphene
  nodes: 
    - name: graphene-1.nancy.grid5000.fr # Full version
      address: 10.0.66.1
    - name: graphene-2.nancy.grid5000.fr
      address: 10.0.66.2
    - name: graphene-3.nancy.grid5000.fr
      address: 10.0.66.3
    - name: graphene-4.nancy.grid5000.fr
      address: 10.0.66.4
- name: griffon
  conf_file: cluster_conf-griffon.yml
  partition_file: cluster_partition-griffon
  nodes: 
    - name: griffon-[1-92].nancy.grid5000.fr # Digest version
      address: 10.0.65.[1-92]
\end{verbatim}
\end{small}

\subsection{Explanation of the fields used in the clusters file\\}
\begin{itemize}
  \item \ypath{/clusters}
  \begin{itemize}
    \item \yfield{name}{String} the name of the cluster
    \item \yfield{prefix}{String} the prefix that will be used for display purpose when deploying nodes from several clusters (if not set, the prefix will be a unique integer identifier)
    \item \yfield{conf\_file}{String} the relative path (in kadeploy configuration directory) to the cluster-specific configuration file of this cluster (see section \ref{sec:specific_config})
    \item \yfield{partition\_file}{String} the partition file for this cluster (see section \ref{sec:partfiles})
  \end{itemize}

  \item \ypath{/clusters/[nodes]}
  \begin{itemize}
    \item \yfield{name}{String} the hostname of the node(s). Ranges can also be used to define hostnames: griffon-[1-92].nancy.grid5000.fr.
    \item \yfield{address}{String} the IP address of the node(s). Ranges can also be used to define addresses: 10.0.65.[1-92] .
  \end{itemize}
\end{itemize}

\section{Cluster-specific configuration files}\label{sec:specific_config}
To define the specific configuration of a cluster, you must create a specific file for each cluster in the configuration directory. The name of the file must be \texttt{specific\_conf\_CLUSTER} where \texttt{CLUSTER} is the cluster name.
\subsection{Example of a cluster-specific configuration file}
\begin{small}
\begin{verbatim}
--- 
partitioning: 
  block_device: /dev/sda
  kind: fdisk
  partitions:
    swap: 1
    prod: 2
    deploy: 3
    tmp: 5
timeouts: 
  reboot: 200 + 150 * Math.log(n)
  kexec: 60
remoteops: 
  reboot: 
    - name: soft
      cmd: |-
        ssh -A -q \
        -o BatchMode=yes -o StrictHostKeyChecking=no \
        -o PreferredAuthentications=publickey \
        -o ConnectTimeout=2 -o UserKnownHostsFile=/dev/null \
        -i /etc/kadeploy3/keys/id_deploy root@HOSTNAME_FQDN
    - name: hard
      cmd: /usr/local/kadeploy/bin/hard_reboot.rb HOSTNAME_SHORT
    - name: very_hard
      cmd: /usr/local/kadeploy/bin/reboot_RSA.exp HOSTNAME_SHORT
  power_on:
#   - name: soft
#      cmd: ...
    - name: hard
      cmd: /usr/bin/lanpower -c on -m HOSTNAME_SHORT
      name: hard
#   - name: very_hard
#      cmd: ...
  power_off: 
    - name: soft
      cmd: |-
        ssh -q -o BatchMode=yes -o StrictHostKeyChecking=no -o \
        PreferredAuthentications=publickey -o ConnectTimeout=2 \
        -o UserKnownHostsFile=/dev/null \
        -i /etc/kadeploy3/keys/id_deploy root@HOSTNAME_FQDN \
        "nohup /sbin/halt &>/dev/null &"
    - name: hard
      cmd: /usr/bin/lanpower -c off -m HOSTNAME_SHORT
#   - name: very_hard
#      cmd: ...
  power_status: 
    - name: soft
      cmd: /usr/bin/lanpower -m HOSTNAME_FQDN -s
  console: 
    - name: soft
      cmd: /usr/local/conman/bin/conman -d conman HOSTNAME_SHORT
kernels:
  user: 
    params: console=tty0 console=ttyS1,38400n8
  deploy:
    vmlinuz: deploy-vmlinuz-2.6.27.8-bt
    initrd: deploy-initrd-2.6.27.8-bt
    params: console=tty0 console=ttyS0,38400n8 ramdisk_size=260000 rw
    drivers: ata_piix,ata_generic
  nfsroot:
    vmlinuz: deploy-vmlinuz-2.6.27.7-nfsroot
    params: rw console=ttyS0,38400n8 console=tty0 root=/dev/nfs ip=dhcp nfsroot=10.0.100.35:/mnt/nfsroot/rootfs init=/sbin/init
preinstall: 
  files:
    - file: /g5k/admin_pre_install.tgz
      format: tgz
      script: launch.sh
postinstall: 
  files:
    - file: /g5k/admin_post_install.tgz
      format: tgz
      script: launch.sh
pxe: 
  headers: PROMPT 1\nSERIAL 0 38400\nDEFAULT bootlabel\nDISPLAY messages\nTIMEOUT 50\n\nlabel bootlabel\n
kexec:
  repository: /dev/shm/kexec_repository
hooks:
  use_ip_to_deploy: true
automata: 
  macrosteps:
    SetDeploymentEnv:
      - type: Prod
        timeout: 200
        microsteps:
          - name: reboot
            timeout: 10
          - name: create_partition_table
            substitute:
              - action: run
                name: my_partitioning
                file: partitioning.sh
                retries: 1
                scattering: tree
                timeout: 16
      - type: Untrusted
        timeout: 400
    BroadcastEnv: 
      - type: Kastafior
        retries: 1
        timeout: 900
        microsteps:
          - name: send_environment
            post-ops:
              - action: send
                file: hostname
                destination: \$KADEPLOY_ENV_EXTRACTION_DIR/etc/
                retries: 1
                scattering: chain
              - action: exec
                command: mkdir -p \$KADEPLOY_ENV_EXTRACTION_DIR/mypath
              - action: send
                file: myfile
                destination: \$KADEPLOY_ENV_EXTRACTION_DIR/mypath
                timeout: 10
    BootNewEnv: 
      - type: Kexec
        timeout: 100
#     - type: Classical
#       retries: 1
#       timeout: 200
      - type: HardReboot
        retries: 1
        timeout: 300
\end{verbatim}
\end{small}

\subsection{Explanation of the fields used in the cluster-specific configuration file\label{sec:specific_config}}

\begin{itemize}
  \item \ypath{/partitioning}
  \begin{itemize}
    \item \yfield{block\_device}{String}block device of the disk used on the nodes
    \item \yfield{kind}{String} tool used to create the partition table (expected values are \texttt{fdisk} or \texttt{parted})
    \item \yfieldd{disable\_swap}{Boolean}{false} disable the swap partition on the disk
  \end{itemize}

  \item \ypath{/partitioning/partitions}
  \begin{itemize}
    \item \yfieldd{swap}{Integer}{1} number of the swap partition on the disk
    \item \yfield{prod}{Integer} number of the production partition on the disk
    \item \yfield{deploy}{Integer} number of the deployment partition on the disk
    \item \yfield{tmp}{Integer} number of the tmp partition on the disk
  \end{itemize}

  \item \ypath{/timeouts}
  \begin{itemize}
    \item \yfield{reboot}{Integer/String} classical reboot timeout. A Ruby expression can be used here to represent a function depending on \emph{n} (the number of nodes currently rebooted)
    \item \yfieldd{kexec}{Integer/String}{60} kexec reboot timeout. A Ruby expression can be used here to represent a function depending on \emph{n} (the number of nodes currently rebooted)
  \end{itemize}

  \item \ypath{/remoteops/[reboot]} The reboot commands, an escalation of them will be performed in the order of the List. Warning: at the moment, only the names \emph{soft}, \emph{hard} and \emph{very\_hard} can be used.
  \begin{itemize}
    \item \yfield{name}{String} the name of the command (used in the display)
    \item \yfield{cmd}{String} generic reboot command. You can use the HOSTNAME\_FQDN and HOSTNAME\_SHORT variables in the command-line.
    \item \yfieldd{group}{String}{nil} the affinity between nodes (see section \ref{sec:groupcmd})
  \end{itemize}

  \item \ypath{/remoteops/[power\_on]} The power\_on commands, an escalation of them will be performed in the order of the List. This commands are not mandatory. Warning: at the moment, only the names \emph{soft}, \emph{hard} and \emph{very\_hard} can be used.
  \begin{itemize}
    \item \yfield{name}{String} the name of the command (used in the display)
    \item \yfield{cmd}{String} generic power\_on command. You can use the HOSTNAME\_FQDN and HOSTNAME\_SHORT variables in the command-line.
    \item \yfieldd{group}{String}{nil} the affinity between nodes (see section \ref{sec:groupcmd})
  \end{itemize}

  \item \ypath{/remoteops/[power\_off]} The power\_off commands, an escalation of them will be performed in the order of the List. This commands are not mandatory. Warning: at the moment, only the names \emph{soft}, \emph{hard} and \emph{very\_hard} can be used.
  \begin{itemize}
    \item \yfield{name}{String} the name of the command (used in the display)
    \item \yfield{cmd}{String} generic power\_off command. You can use the HOSTNAME\_FQDN and HOSTNAME\_SHORT variables in the command-line.
    \item \yfieldd{group}{String}{nil} the affinity between nodes (see section \ref{sec:groupcmd})
  \end{itemize}

  \item \ypath{/remoteops/[power\_status]} The power\_status commands, an escalation of them will be performed in the order of the List. This commands are not mandatory. This commands are not mandatory. Warning: at the moment, only the name \emph{soft} can be used.
  \begin{itemize}
    \item \yfield{name}{String} the name of the command (used in the display)
    \item \yfield{cmd}{String} generic power\_status command. You can use the HOSTNAME\_FQDN and HOSTNAME\_SHORT variables in the command-line.
  \end{itemize}

  \item \ypath{/remoteops/[console]} The console commands, an escalation of them will be performed in the order of the List. This commands are not mandatory. This commands are not mandatory. Warning: at the moment, only the name \emph{soft} can be used.
  \begin{itemize}
    \item \yfield{name}{String} the name of the command (used in the display)
    \item \yfield{cmd}{String} generic console command. You can use the HOSTNAME\_FQDN and HOSTNAME\_SHORT variables in the command-line.
  \end{itemize}

  \item \ypath{/kernels/user}
  \begin{itemize}
    \item \yfieldd{params}{String}{''} default kernel parameters applied to a Linux based deployed environment. This can be overloaded in the environment description.
  \end{itemize}

  \item \ypath{/kernels/deploy}
  \begin{itemize}
    \item \yfield{vmlinuz}{String} name of the kernel used by the deployment environment. This file will be specified in the PXE profiles using the \ypath{pxe/export} and \ypath{pxe/kernels/directory} settings of the general configuration file.
    \item \yfield{initrd}{String} name of the initrd used by the deployment environment. This file will be specified in the PXE profiles using the \ypath{pxe/export} and \ypath{pxe/kernels/directory} settings of the general configuration file.
    \item \yfieldd{params}{String}{''} boot parameters of the deployment environment kernel
    \item \yfieldd{drivers}{String}{''} list of drivers that must be loaded in the deployment environment. The syntax is: driver1,driver2,driver3,...
  \end{itemize}

  \item \ypath{/kernels/nfsroot}
  \begin{itemize}
    \item \yfieldd{vmlinuz}{String}{''} kernel for the NFS-root deployment environment (only used if you use an NFS-root deployment environment)
    \item \yfieldd{params}{String}{''} kernel parameters for the NFS-root deployment environment (only used if you use an NFS-root deployment environment)
  \end{itemize}

  \item \ypath{/preinstall/[files]} list of pre-install to execute at the pre-install of a deployment. This fields are not mandatory. 
  \begin{itemize}
    \item \yfield{file}{String} the absolute path to the archive containing the scripts
    \item \yfield{format}{String} the kind of file (expected values are \emph{tgz} or \emph{tbz2})
    \item \yfield{script}{String} the relative path (inside of the archive) to the script to be executed. The \textit{none} value can be if no script must be launched. For debug purpose, you can use the keyword \texttt{breakpoint} instead of a script. Thus, the file will be transferred, the deployment workflow will be stopped and you will be able to connect in the deployment environment to debug. 
  \end{itemize}

  \item \ypath{/postinstall/[files]} list of post-install to execute at the post-install of a deployment. This fields are not mandatory. 
  \begin{itemize}
    \item \yfield{file}{String} the absolute path to the archive containing the scripts
    \item \yfield{format}{String} the kind of file (expected values are \emph{tgz} or \emph{tbz2})
    \item \yfield{script}{String} the relative path (inside of the archive) to the script to be executed. The \textit{none} value can be if no script must be launched. For debug purpose, you can use the keyword \texttt{breakpoint} instead of a script. Thus, the file will be transferred, the deployment workflow will be stopped and you will be able to connect in the deployment environment to debug. 
  \end{itemize}

  \item \ypath{/pxe}
  \begin{itemize}
    \item \yfieldd{headers}{String}{''} default PXE header (must be defined in one line, you can use the \\n notation to add newlines)
  \end{itemize}

  \item \ypath{/kexec}
  \begin{itemize}
    \item \yfieldd{repository}{String}{/dev/shm/kexec\_repository} the directory in the running system where deploy kernel files have to be copied for kexec purpose
  \end{itemize}

  \item \ypath{/hooks}
  \begin{itemize}
    \item \yfieldd{use\_ip\_to\_deploy}{Boolean}{false} use IP addresses instead of hostnames to contact the nodes
  \end{itemize}

  \item \ypath{/automata/macrosteps} list of implementations for each macro-steps of the automata. There are 3 macro-steps, so you must specify each of them.
  \item \ypath{/automata/macrosteps/[SetDeploymentEnv]} the macro-step in charge of rebooting the nodes on the deployment environment
  \begin{itemize}
    \item \yfield{type}{String} the type of the macro-step (expected values are \emph{Untrusted}, \emph{Kexec}, \emph{Prod}, \emph{Nfsroot}, \emph{UntrustedCustomPreInstall} and \emph{Dummy})
    \item \yfieldd{retries}{Integer}{0} the number of retries for this macro-step (by default, one single attempt with no retries)
    \item \yfield{timeout}{Integer} the timeout (seconds) of this macro-step
  \end{itemize}
  \item \ypath{/automata/macrosteps/[SetDeploymentEnv]/[microsteps]} Microsteps specific configuration (this field is not mandatory)
  \begin{itemize}
    \item \yfield{name}{String} the name of the micro-step, see the list bellow to get the different micro-steps names.
    \item \yfieldd{timeout}{Integer}{0} the timeout (seconds) of this micro-step
    \item \yfieldd{retries}{Integer}{0} the number of retries for this micro-step. Since most of micro-steps perform some modifications on the running system and are do not perform any cleaning operation before their execution, be very careful when using this setting.
  \end{itemize} 
  \item \ypath{/automata/macrosteps/[SetDeploymentEnv]/[microsteps]/[substitute]} Substitute this micro-step with some custom operations (see the paragraph bellow for custom operations description)
  \item \ypath{/automata/macrosteps/[SetDeploymentEnv]/[microsteps]/[pre-ops]} A list of operations that have to be done before executing the micro-step (see the paragraph bellow for custom operation description)
  \item \ypath{/automata/macrosteps/[SetDeploymentEnv]/[microsteps]/[post-ops]} A list of custom operations that have to be done after executing the micro-step (see the paragraph bellow for custom operation description)


  \item \ypath{/automata/macrosteps/[BroadcastEnv]} the macro-step in charge of broadcasting the image of the user's environment image on the nodes
  \begin{itemize}
    \item \yfield{type}{String} the type of the macro-step (expected values are \emph{Kastafior}, \emph{Chain}, \emph{Tree}, \emph{Bittorrent} and \emph{Dummy})
    \item \yfieldd{retries}{Integer}{0} the number of retries for this macro-step
    \item \yfield{timeout}{Integer} the timeout (seconds) of this macro-step (0 for no timeout)
  \end{itemize}
  \item \ypath{/automata/macrosteps/[BroadcastEnv]/[microsteps]} Microsteps specific configuration (this field is not mandatory)
  \begin{itemize}
    \item \yfield{name}{String} the name of the micro-step, see the list bellow to get the different micro-steps names.
    \item \yfieldd{timeout}{Integer}{0} the timeout (seconds) of this micro-step
    \item \yfieldd{retries}{Integer}{0} the number of retries for this micro-step. Since most of micro-steps perform some modifications on the running system and are do not perform any cleaning operation before their execution, be very careful when using this setting.
  \end{itemize} 
  \item \ypath{/automata/macrosteps/[BroadcastEnv]/[microsteps]/[substitute]} Substitute this micro-step with some custom operations (see the paragraph bellow for custom operations description)
  \item \ypath{/automata/macrosteps/[BroadcastEnv]/[microsteps]/[pre-ops]} A list of operations that have to be done before executing the micro-step (see the paragraph bellow for custom operation description)
  \item \ypath{/automata/macrosteps/[BroadcastEnv]/[microsteps]/[post-ops]} A list of custom operations that have to be done after executing the micro-step (see the paragraph bellow for custom operation description)


  \item \ypath{/automata/macrosteps/[BootNewEnv]} the macro-step in charge of rebooting the nodes after the installation of the environment
  \begin{itemize}
    \item \yfield{type}{String} the type of the macro-step (expected values are \emph{Classical}, \emph{Kexec}, \emph{HardReboot}, \emph{PivotRoot} (not implemented yet) and \emph{Dummy})
    \item \yfieldd{retries}{Integer}{0} the number of retries for this macro-step
    \item \yfield{timeout}{Integer} the timeout (seconds) of this macro-step
  \end{itemize} 
  \item \ypath{/automata/macrosteps/[BootNewEnv]/[microsteps]} Microsteps specific configuration (this field is not mandatory)
  \begin{itemize}
    \item \yfield{name}{String} the name of the micro-step, see the list bellow to get the different micro-steps names.
    \item \yfieldd{timeout}{Integer}{0} the timeout (seconds) of this micro-step
    \item \yfieldd{retries}{Integer}{0} the number of retries for this micro-step. Since most of micro-steps perform some modifications on the running system and are do not perform any cleaning operation before their execution, be very careful when using this setting.
  \end{itemize} 
  \item \ypath{/automata/macrosteps/[BootNewEnv]/[microsteps]/[substitute]} Substitute this micro-step with some custom operations (see the paragraph bellow for custom operations description)
  \item \ypath{/automata/macrosteps/[BootNewEnv]/[microsteps]/[pre-ops]} A list of operations that have to be done before executing the micro-step (see the paragraph bellow for custom operation description)
  \item \ypath{/automata/macrosteps/[BootNewEnv]/[microsteps]/[post-ops]} A list of custom operations that have to be done after executing the micro-step (see the paragraph bellow for custom operation description)
\end{itemize}
\paragraph{Custom operations\label{custom-op}\\}
With custom operations you can send files or execute commands.

Here is a custom operation description:
\begin{itemize}
  \item \yfield{name}{String} The name of the custom operation
  \item \yfield{action}{String} The action that have to be performed (expected values are \emph{send}, \emph{run} and \emph{exec})
  \item \yfield{file}{String} \small{(To be specified if the action is \emph{send} or \emph{run})} The path to the file to be send/executed (if the action is \emph{send} the file name will remains the same, if the action is \emph{run} this file need to contain a script)
  \item \yfield{destination}{String} \small{(To be specified if the action is \emph{send})} The destination directory on the nodes (Kadeploy3 specific environment variables are substitued in the path)
  \item \yfield{command}{String} \small{(To be specified if the action is \emph{exec})} The command to be executed. If you want to call a script, dont forget to add a \emph{.} before the script name to be able to use Kadeploy3 specific environment variables inside of it (example: \texttt{command: . /myscript.sh}).
  \item \yfieldd{timeout}{Integer}{0} the timeout (seconds) of this custom operation
  \item \yfieldd{retries}{Integer}{0} the number of retries for this custom operation
  \item \yfieldd{scattering}{String}{'tree'} The scattering kind for this custom operation (expected values are \emph{tree} and \emph{chain})
\end{itemize} 
\paragraph{The automata macro-steps\\}
Here is the list of the macro-step and their implementation:
\begin{itemize}
\item \texttt{SetDeploymentEnv}
  \begin{itemize}
  \item \texttt{SetDeploymentEnvProd}
    \begin{itemize}
    \item check\_nodes
    \item format\_deploy\_part
    \item mount\_deploy\_part
    \item format\_tmp\_part
    \end{itemize}
  \item \texttt{SetDeploymentEnvUntrusted}
    \begin{itemize}
    \item switch\_pxe
    \item reboot
    \item wait\_reboot
    \item send\_key\_in\_deploy\_env
    \item create\_partition\_table
    \item format\_deploy\_part
    \item mount\_deploy\_part
    \item format\_tmp\_part
    \item format\_swap\_part
    \end{itemize}
  \item \texttt{SetDeploymentEnvKexec}
    \begin{itemize}
    \item send\_deployment\_kernel
    \item kexec
    \item wait\_reboot
    \item send\_key\_in\_deploy\_env
    \item create\_partition\_table
    \item format\_deploy\_part
    \item mount\_deploy\_part
    \item format\_tmp\_part
    \item format\_swap\_part
    \end{itemize}
  \item \texttt{SetDeploymentEnvUntrustedCustomPreInstall}
    \begin{itemize}
    \item switch\_pxe
    \item reboot
    \item wait\_reboot
    \item send\_key\_in\_deploy\_env
    \item manage\_admin\_pre\_install
    \end{itemize}
  \item \texttt{SetDeploymentEnvNfsroot}
    \begin{itemize}
    \item switch\_pxe
    \item reboot
    \item wait\_reboot
    \item send\_key\_in\_deploy\_env
    \item create\_partition\_table
    \item format\_deploy\_part
    \item mount\_deploy\_part
    \item format\_tmp\_part
    \end{itemize}
  \item \texttt{SetDeploymentEnvDummy}
  \end{itemize}
\item \texttt{BroadcastEnv}
  \begin{itemize}
    \item \texttt{BroadcastEnvChain}
      \begin{itemize}
      \item send\_environment(``chain'')
      \item manage\_admin\_post\_install
      \item manage\_user\_post\_install
      \item check\_kernel\_files
      \item send\_key
      \item install\_bootloader
      \end{itemize}
    \item \texttt{BroadcastEnvKastafior}
      \begin{itemize}
      \item send\_environment(``kastafior'')
      \item manage\_admin\_post\_install
      \item manage\_user\_post\_install
      \item check\_kernel\_files
      \item send\_key
      \item install\_bootloader
      \end{itemize}
    \item \texttt{BroadcastEnvTree}
      \begin{itemize}
      \item send\_environment(``tree'')
      \item manage\_admin\_post\_install
      \item manage\_user\_post\_install
      \item check\_kernel\_files
      \item send\_key
      \item install\_bootloader
      \end{itemize}
    \item \texttt{BroadcastEnvBittorrent}
      \begin{itemize}
      \item send\_environment(``bittorrent'')
      \item manage\_admin\_post\_install
      \item manage\_user\_post\_install
      \item check\_kernel\_files
      \item send\_key
      \item install\_bootloader
      \end{itemize}
    \item \texttt{BroadcastEnvDummy}
  \end{itemize}
\item \texttt{BootNewEnv}
  \begin{itemize}
    \item \texttt{BootNewEnvClassical}
      \begin{itemize}
      \item switch\_pxe
      \item umount\_deploy\_part
      \item reboot\_from\_deploy\_env
      \item wait\_reboot
      \end{itemize}
    \item \texttt{BootNewEnvKexec}
      \begin{itemize}
      \item switch\_pxe
      \item umount\_deploy\_part
      \item mount\_deploy\_part
      \item kexec
      \item wait\_reboot
      \end{itemize}
    \item \texttt{BootNewEnvHardReboot}
      \begin{itemize}
      \item switch\_pxe
      \item reboot(``hard'')
      \item wait\_reboot
      \end{itemize}
    \item \texttt{BootNewEnvDummy}
  \end{itemize}
\end{itemize}

\paragraph{Note about the reboot/power-on/power-off commands}\label{sec:groupcmd}
In some special cases, a such command can affect a group of nodes. Thus, you can specify group of nodes for a given command using the following syntax :
\begin{small}
\begin{verbatim}
---
# ...
remoteops:
  reboot:
    - name: very_hard
      cmd: /usr/sbin/very_hard_power_off GROUP_SHORT
      group: path_to_group_of_node_for_hard_power_off_cmd
# ...
\end{verbatim}
\end{small}
You can remark two things :
\begin{itemize}
\item the \texttt{HOSTNAME\_SHORT} and \texttt{HOSTNAME\_FQDN} patterns are not used in these commands, instead you must use the \texttt{GROUP\_SHORT} and \texttt{GROUP\_FQDN} patterns.
\item the affinity between nodes is specified in a file (here \texttt{path\_to\_group\_of\_node\_for\_hard\_power\_off\_cmd}) that contains as much lines as the number of groups. Then, each line contains the nodes of a group, for instance: \texttt{node1,node2,node3}.
\end{itemize}
For a given command on a given cluster, if you specify some group of nodes (with \texttt{GROUP\_SHORT} or \texttt{GROUP\_FQDN} patterns), you will also be able to specify, for some nodes of the cluster, a command that does not imply a group of nodes. To do this, you must specify these commands in the specific commands configuration files.

\section{Partition map files}\label{sec:partfiles}
A partition map must be provided for each cluster. 

If you specify \texttt{fdisk} for the \ypath{/partitioning/kind} field in the cluster-specific configuration file, the partition map file must be a fdisk map. In this case, concerning the type of the deployment partition (MSDOS partition type), you must use the value \texttt{PARTTYPE} instead of a real value. Thus, this value will be modified on the fly according to the kind of environment deployed (field \texttt{fdisktype} of the environment description). You can also use the values \texttt{PARTTYPE}$N$ (for sample, \texttt{PARTTYPE3}), where $N$ is a partition number: during the deployment process, if you are deploying on the partition number $X$, \texttt{PARTTYPE}$X$ will be substitued by the partition type and every \texttt{PARTTYPE}$Y$ where $Y \neq X$ by \emph{0} (empty partition).

If you specify \texttt{parted} for the \ypath{/partitioning/kind} field in the cluster-specific configuration file, you must provide a file containing a parted map. In this case, concerning the kind of the deployment partition, you must use the value \texttt{PARTTYPE} instead of a real value. Thus, this value will be modified on the fly according to the kind of filesystem deployed (field \texttt{filesystem} of the environment description). You can also use the values \texttt{PARTTYPE}$N$ (for sample, \texttt{PARTTYPE3}), where $N$ is a partition number: during the deployment process, if you are deploying on the partition number $X$, \texttt{PARTTYPE}$X$ will be substitued by the filesystem kind and every \texttt{PARTTYPE}$Y$ where $Y \neq X$ by an empty string.



\section{Specific commands configuration files}
In the part~\ref{sec:specific_config} we saw that generic commands can be given to all the nodes that belong to a cluster. It is also possible to override these generic values for some specific nodes. To do this, you must fill the file named \texttt{cmd.yml} in the configuration directory.

Note: it is not mandatory to override all the commands for a given node.

\subsection{Example of a commands file\\}
\begin{small}
\begin{verbatim}
---
vm-001:
  reboot_soft: ssh -q root@vm-001 /sbin/special_reboot_for_vm
  reboot_hard: vmware-cmd /home/vmware/vm-001/vm-001.vmx reset hard
vm-002:
  reboot_soft: ssh -q root@vm-002 /sbin/special_reboot_for_vm
\end{verbatim}
\end{small}

\subsection{Explanation of the fields used in the commands file\\}
\begin{itemize}
  \item \ypath{/NODENAME} The nodes are specified by hostname (as declared in the clusters configuration file)
  \begin{itemize}
    \item \yfield{COMMAND}{String} the setting to override and the command
  \end{itemize}
\end{itemize}

The COMMAND can should be:
\begin{itemize}
  \item \texttt{reboot\_soft} to override \ypath{/remoteops/reboot/[]/name=soft}
  \item \texttt{reboot\_hard} to override \ypath{/remoteops/reboot/[]/name=hard}
  \item \texttt{reboot\_very\_hard} to override \ypath{/remoteops/reboot/[]/name=very\_hard}
  \item \texttt{power\_on\_soft} to override \ypath{/remoteops/power\_on/[]/name=soft}
  \item \texttt{power\_on\_hard} to override \ypath{/remoteops/power\_on/[]/name=hard}
  \item \texttt{power\_on\_very\_hard} to override \ypath{/remoteops/power\_on/[]/name=very\_hard}
  \item \texttt{power\_off\_soft} to override \ypath{/remoteops/power\_off/[]/name=soft}
  \item \texttt{power\_off\_hard} to override \ypath{/remoteops/power\_off/[]/name=hard}
  \item \texttt{power\_off\_very\_hard} to override \ypath{/remoteops/power\_off/[]/name=very\_hard}
  \item \texttt{power\_status} to override \ypath{/remoteops/power\_status/[]/name=soft}
  \item \texttt{console} to override \ypath{/remoteops/console/[]/name=soft}
\end{itemize}


\section{Deployment environment}
There are three ways to set a deployment environment: using the production environment, using a dedicated environment, using an NFSRoot environment.

\subsection{Configuration of the production environment}
TODO
\subsection{Creation of the dedicated environment}
This methods consists in creating a kernel/initrd that contains all the tools required to perform a deployment. Two scripts are provided to ease the creation of the deployment environment. To use these scripts, go to the \texttt{addons/deploy\_env\_generation/debootstrap} directory and execute with root rights:
\begin{small}
\begin{verbatim}
> sh make_debootstrap.sh
> sh make_kernel.sh
\end{verbatim}
\end{small}

The \texttt{make\_debootstrap.sh} script can be tuned if you want to add or remove some packages in the filesystem. To do this, you can modify the \texttt{DEBOOTSTRAP\_INCLUDE\_PACKAGES} and \texttt{DEBOOTSTRAP\_INCLUDE\_PACKAGES} values.

The \texttt{make\_kernel.sh} script prompts the user the following things:
\begin{itemize}
\item the size of the uncompressed initrd in KB;
\item the kernel version;
\item the absolute path to a kernel config file;
\item the use of automatic configuration for the new fields in kernel configuration.
\end{itemize}

The size of the uncompressed initrd depends on what you have to put in your deployment environment. If you use the \texttt{make\_debootstrap.sh} script, the initrd size should be at least 200MB.
Depending on the kernel version you choose, the script will fetch the vanilla kernel corresponding to this version. Once a kernel has been fetched, it won't be fetched again in another run. Thus, you have to delete the kernel file if you want to fetch it again. At the opposite, if you do not want to use the sources of the vanilla kernel but your own sources, you can put your own kernel (tar.bz2 compressed) in the current directory. The only requirement is to name the file with the following pattern: linux-\textit{version}.tar.bz2. Then, at the kernel version prompt, just enter the \textit{version} value.

After the execution of \texttt{make\_kernel.sh}, a directory prefixed with \texttt{built-} will be created. This directory contains the kernel and the initrd files, prefixed with \texttt{deploy-}.

\subsection{Creation of the NFSRoot environment}
TODO

\section{Configuration of the deploy user}
In order to use the Kastafior based file broadcaster (\texttt{BroadcastEnvKastafior} macro-step), the server must be able to perform an ssh connection on itself. Thus, you must add the deploy key installed in the \texttt{/etc/kadeploy3/keys/id\_deploy.pub} in the \texttt{.ssh/authorized\_keys} file of the \texttt{deploy} user. This step is optional if you do not plan to use the \texttt{BroadcastEnvKastafior} macro-step.

\chapter{Client side configuration}
On the client side, you only have to configure the file named \texttt{client\_conf.yml}. This file defines Kadeploy servers and a default server.

\paragraph{Sample of a client configuration file}
\begin{verbatim}
---
default: nancy
servers:
  - name: lille
    hostname: frontend.lille.grid5000.fr
    port: 25300
  - name: nancy
    hostname: nancy.lille.grid5000.fr
    port: 25300
\end{verbatim}

\paragraph{Explanation of the fields\\}
\begin{itemize}
  \item \yfield{\ypath{/default}}{String} the default Kadeploy server to use (name should be included in the list of \ypath{/[servers]/name})
  \item \ypath{/[servers]} The different servers
  \begin{itemize}
    \item \yfield{name}{String} the Kadeploy server name
    \item \yfield{hostname}{String} the Kadeploy server hostname
    \item \yfield{port}{Integer} the port the Kadeploy server is listening on
  \end{itemize}
\end{itemize}

\chapter{User guide}

\section{Overview of the Kadeploy tools}
\subsection{Kadeploy}
The Kadeploy tool is base on a client/server architecture. Thus, it is composed both of a server part and a client part. The server must be run with the root rights and the client is used with standard rights.

\subsection{Kareboot}
Kareboot is designed to perform several reboot operations on the nodes.

\subsection{Kaenv}
Kaenv is designed to manage the users environments.

\subsection{Kaconsole}
Kaconsole is designed to provide a user to access to the consoles of the nodes on which the user has the deployment rights.

\subsection{Kastat}
Kastat is designed to show several statistics about the deployments.

\subsection{Kanodes}
Kanodes is designed to show the state of the nodes.

\subsection{Kapower}
Kapower is designed to control the power state of the nodes.

\subsection{Karights}
Karights is designed to allow users to perform some deployments on a set of nodes throughout a reservation. This tool is typically called by the resource manager at the prologue and epilogue steps.

\section{Use the Kadeploy tools}
\subsection{Kadeploy server}
All the Kadeploy tools use the Kadeploy server. On a well configured system, the Kadeploy server can be launched with the following command (with root rights):
\begin{verbatim}
> kadeploy3d
\end{verbatim}

\subsection{Kadeploy client}\label{sec:kadeploy_client}
The Kadeploy client is actually the user interface for the Kadeploy software. It can be used by using the \texttt{kadeploy3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kadeploy3 -h
Usage: kadeploy3 [options]
Contact: kadeploy3-users@lists.grid5000.fr
General options:
  -a, --env-file ENVFILE           File containing the environment description
  -b, --block-device BLOCKDEVICE   Specify the block device to use
  -c, --chainload-partition NUMBER Specify the number of the partition to chainload on
  -d, --debug-mode                 Activate the debug mode
  -e, --env-name ENVNAME           Name of the recorded environment to deploy
  -f, --file MACHINELIST           Files containing list of nodes (- means stdin)
  -k, --key [FILE]                 Public key to copy in the root's authorized_keys, 
                                   if no argument is specified, use the authorized_keys
  -m, --machine MACHINE            Node to run on
      --multi-server               Activate the multi-server mode
  -n, --output-ko-nodes FILENAME   File that will contain the nodes not correctly deployed
  -o, --output-ok-nodes FILENAME   File that will contain the nodes correctly deployed
  -p, --partition-number NUMBER    Specify the partition number to use
  -r, --reformat-tmp FSTYPE        Reformat the /tmp partition with the given filesystem type
                                   (ext[234] are allowed)
  -s, --script FILE                Execute a script at the end of the deployment
  -u, --user USERNAME              Specify the user
  -v, --version                    Get the version
      --vlan VLANID                Set the VLAN"
  -w, --set-pxe-profile FILE       Set the PXE profile (use with caution)
      --set-pxe-pattern FILE      Specify a file containing the substituation of a pattern for 
                                  each node in the PXE profile (the NODE_SINGULARITY pattern must
                                  be used in the PXE profile)
  -x, --upload-pxe-files FILES     Upload a list of files (file1,file2,file3) to the "tftp_images_path"
                                   directory. Those files will then be available in the KERNELS_DIR directory with the prefix FILES_PREFIX--
      --env-version NUMBER         Number of version of the environment to deploy
      --server STRING              Specify the Kadeploy server to use
  -V, --verbose-level VALUE        Verbose level between 0 to 5
Advanced options:
      --write-workflow-id FILE     Write the workflow id in a file
      --ignore-nodes-deploying     Allow to deploy even on the nodes tagged as "currently deploying" 
                                   (use this only if you know what you do)
      --disable-bootloader-install Disable the automatic installation of a bootloader for a 
                                   Linux based environment
      --disable-disk-partitioning  Disable the disk partitioning
      --breakpoint MICROSTEP       Set a breakpoint just before launching the give micro-step, the 
                                   syntax is macrostep:microstep (use this only if you know what you do)
      --set-custom-operations FILE Add some custom operations defined in a file
      --reboot-classical-timeout V Overload the default timeout for classical reboots
      --reboot-kexec-timeout V     Overload the default timeout for kexec reboots
      --force-steps STRING         Undocumented, for administration purpose only

\end{verbatim}
\end{small}

At least, Kadeploy must be called with one node and an environment. The nodes to deploy can be specified by using several \texttt{-m|--machine} options, or the \texttt{-f|--file} options (one node per line in the file), or a mix of both.
The environment can be specified with the \texttt{-e|--env-name} option if you want to use an environment recorded in the environment database or with the \texttt{-a|--env-file} options if you want to use an environment described in a file. Refer to the~\ref{sec:kaenv} part for information about the environment description. Here are some examples:
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr -e lenny-x64-nfs-1.0 -o nodes_ok -n nodes_ko
> kadeploy3 -m gdx-[5-12].orsay.grid5000.fr -e lenny-x64-base -o nodes_ok -n nodes_ko
> kadeploy3 -f nodes -a custom_env.dsc
> kadeploy3 -f nodes -m gdx-5.orsay.grid5000.fr -a custom_env.dsc
> cat nodefile|kadeploy3 -f - -e lenny-x64-base
\end{verbatim}

We present now several use cases.

\paragraph{Use case 1 - basic usage - deployment of a node}
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr \
            -e lenny-x64-nfs-1.0 \
            --verbose-level 5 \
            -k ~/.ssh/id_rsa.pub
\end{verbatim}
This command performs the deployment of the environment \textit{lenny-x64-nfs-1.0} on the node \textit{gdx-5.orsay.grid5000.fr} and copies the SSH public key \textit{~/.ssh/id\_rsa.pub} of the user in the deployed environment to allow a direct connection with the root account. Furthermore, the verbose level is set to 5, which means that you want the maximum verbose information.


\paragraph{Use case 2 - basic usage - deployment of a range of nodes}
\begin{verbatim}
> kadeploy3 -m gdx-[45-51].orsay.grid5000.fr  \
            -e lenny-x64-base \
            -k
\end{verbatim}
This command performs the deployment of the environment \textit{lenny-x64-base} on the nodes \textit{gdx-45.orsay.grid5000.fr}, \textit{gdx-46.orsay.grid5000.fr}, ..., \textit{gdx-51.orsay.grid5000.fr}. Furthermore, it copies the entries of the \texttt{~/.ssh/authorized\_keys} user file in the \texttt{/root/.ssh/authorized\_keys} of the deployed nodes.

\paragraph{Use case 3 - basic usage - deployment of a set of nodes}
\begin{verbatim}
> kadeploy3 -f ~/machinefile \
            -e custom_env \
            -l johnsmith \
            -o nodes_ok -n nodes_ko
\end{verbatim}
This command uses the environment \textit{custom\_env} of the user \textit{johnsmith} to deploy the nodes specified in \textit{~/machinefile}. The list of the nodes correctly deployed will be written in the file specified with the \texttt{-o|--output-ok-nodes} option. Idem for the nodes not correctly deployed with the \texttt{-o|--output-ko-nodes} option. Refer to the part~\ref{sec:kaenv} about Kaenv to know more about the environment management.

\paragraph{Use case 4 - basic usage - execution of a script after deployment}
\begin{verbatim}
> kadeploy3 -f $OAR_NODE_FILE \
            -a ~/my-lenny.dsc \
            -r ext3 \
            -p 4 \
            -s ~/launcher.sh
\end{verbatim}
This command performs the deployment of the environment described by the file \textit{~/my-lenny.dsc} (useful if you don't want to share your environment with the other users) on the nodes specified in the file pointed by \texttt{\$OAR\_NODE\_FILE} (typically a variable set by the resource manager). We specify here that we want the /tmp partition to be reformated. Furthermore, we specify that we want to deploy the environment on the 4th disk partition, instead of the default one. Finally, we ask to execute the script \textit{~/launcher.sh} at the end of the deployment.

\paragraph{Use case 5 - advanced usage - play with breakpoint}
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr \
            -e lenny-x64-nfs-1.0 \
            --verbose-level 5 \
            --breakpoint BroadcastEnvKastafior:manage_user_post_install \
            -d
\end{verbatim}
This kind of command can be used for debug purpose. It performs a deployment with the maximum verbose level and it asks to stop the deployment workflow just before executing the \textit{manage\_user\_post\_install} micro-step of the \textit{BroadcastEnvKastafior} macro-step. Thus you will be able to connect in the deployment environment and to debug what you want. Furthermore, the full output of the distant commands performed is shown.

\paragraph{Use case 6 - advanced usage - specific PXE profile}
\begin{verbatim}
> kadeploy3 -m gdx-[5-10].orsay.grid5000.fr \
            -e lenny-x64-nfs-1.0 \
            -w ~/pxe_profile -x "~/custom-kernel,~/custom-initrd" \
            --set-pxe-pattern ~/singularities
\end{verbatim}
In some specific case, you may want to use a specific PXE profile to boot your nodes. To do this, you have to provide a PXE profile. Warning, the files used in your PXE profil (Comboot, kernel, initrd, ...) must be readable by the TFTP server on the Kadeploy server. So Kadeploy offers a feature to stage some files in an area where the files can be read by the TFTP server. This can be achieved with the \texttt{-x|--upload-pxe-files} option. You must know that such uploaded files will be copied in the \texttt{tftp\_images\_path}. Those files will then be available in the \texttt{KERNELS\_DIR} directory with the prefix \texttt{FILES\_PREFIX--}.

Here is an example of PXE profile that uses uploaded files:
\begin{verbatim}
PROMPT 1
SERIAL 0 38400
DEFAULT bootlabel
DISPLAY messages
TIMEOUT 50

label bootlabel
        KERNEL KERNELS_DIR/FILES_PREFIX-custom-kernel
        APPEND initrd=KERNELS_DIR/FILES_PREFIX-custom-initrd root=/dev/sda3 node_id=NODE_SINGULARITY
\end{verbatim}

In this example, \texttt{KERNELS\_DIR} will be replaced by the directory where the kernels are located inside of the TFTP directory; \texttt{FILES\_PREFIX--} will be replaced by the prefix added to each files sent into the TFTP repository via the \texttt{-x|--upload-pxe-files} option (be careful not to forget to add \texttt{--} between this prefix and your filenames).

You can notice the \texttt{NODE\_SINGULARITY} pattern used in the PXE profile. Thanks to the \texttt{--set-pxe-pattern} option, you can also provide a file that defines a value in the PXE profile that depends on the node concerned. This file must define on each line a couple of value as follows : hostname,node singularity. In our example, the file \texttt{~/singularities} can contains something like:
\begin{verbatim}
gdx-5.orsay.grid5000.fr,1
gdx-6.orsay.grid5000.fr,2
gdx-7.orsay.grid5000.fr,3
gdx-8.orsay.grid5000.fr,3
gdx-9.orsay.grid5000.fr,4
gdx-10.orsay.grid5000.fr,5
\end{verbatim}

\paragraph{Use case 7 - advanced usage - specific bootloader requirement}
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr \
            -e Custom_linux_env \
            --disable-bootloader-install
\end{verbatim}
If you deploy a Linux based environment and if the administrator choose to boot the nodes with the \textit{chainload} fashion, Kadeploy will install automatically a bootloader on the deployment partition. In some cases, you may want to bypass this installation because you have installed at the time of a previous deployment another bootloader. This allows to avoid the overriding of the installed bootloader. However, if no bootloader is installed or if the installed bootdloader is not able to boot your environment, the won't be reachable at the end of the deployment.

\paragraph{Use case 8 - advanced usage - get a workflow id for an external deployment tracking}\label{par:usecase-wid}
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr \
            -e Custom_linux_env \
            --write-workflow-id wid_file
\end{verbatim}
This command performs the deployment of the \textit{Custom\_linux\_env} environment and write the workflow id of this deployment in the file \textit{wid\_file}. The aim of getting the deployment id is to monitor the deployment from an extern tool thanks to the Kanodes tool.

\paragraph{Use case 9 - expert usage - modify the deployment workflow}
\begin{verbatim}
> kadeploy3 -m gdx-5.orsay.grid5000.fr \
            -e "FreeBSD 7.1" \
            --force-steps "SetDeploymentEnv|SetDeploymentEnvProd:2:100&
                           BroadcastEnv|BroadcastEnvKastafior:2:300&
                           BootNewEnv|BootNewEnvKexec:1:150"
\end{verbatim}
If you are a power user, you can specify the full Kadeploy workflow and bypass the default configuration. Use it at your own risk since the nodes may not support all the Kadeploy features like the \textit{Kexec} optimization for instance. The syntax for the \texttt{--force-steps} option is the same that for the \ypath{/automata/macrosteps} field if the Kadeploy configuration. The difference is that the three macrostep are defined on the same line, with the \texttt{\&} character as a delimiter between the macro-steps. Warning, you must define at least one implementation for each macro-step, without newline (unlike the example).

\paragraph{Use case 10 - expert usage - insert custom operations in the deployment workflow}
\begin{verbatim}
> kadeploy3 -m griffon-1.nancy.grid5000.fr \
            -e squeeze-x64-base \
            --set-custom-operations ~/custom_ops.yml
\end{verbatim}
For very specific purpose, you can add some custom operations in the deployment workflow. To do this, you have to specify these operations in a YAML file where you can specify the operations that must be executed before/after/instead a micro-step.

Here is a description of the YAML file:
\begin{itemize}
  \item \ypath{/MacroStepName} The name of the target macro-step (see section \ref{sec:specific_config} for a list of allowed macro-steps)
  \item \ypath{/MacroStepName/MicroStepName} The name of the target micro-step (see section \ref{sec:specific_config} for a list of allowed micro-steps)
  \begin{itemize}
    \item \yfieldd{override}{Boolean}{false} Override custom steps that have been defined in the cluster configuration.
  \end{itemize}
  \item \ypath{/MicroStepName/MicroStepName/[substitute]} Substitute this micro-step with some custom operations (see section \ref{sec:specific_config} for custom operations description)
  \item \ypath{/MicroStepName/MicroStepName/[pre-ops]} A list of operations that have to be done before executing the micro-step (see section \ref{sec:specific_config} for custom operation description)
  \item \ypath{/MicroStepName/MicroStepName/[post-ops]} A list of custom operations that have to be done after executing the micro-step (see section \ref{sec:specific_config} for custom operation description)
\end{itemize}

When you are executing a command or a script (via the \texttt{exec} or \texttt{run} action), you can use the following environment variables :
\begin{itemize}
\item \texttt{KADEPLOY\_CLUSTER} : cluster on which the pre/post install is launched
\item \texttt{KADEPLOY\_ENV} : environment deployed
\item \texttt{KADEPLOY\_ENV\_KERNEL} : the path to the kernel file inside the deployed environment directory
\item \texttt{KADEPLOY\_ENV\_INITRD} : the path to the initrd file inside the deployed environment directory
\item \texttt{KADEPLOY\_ENV\_KERNEL\_PARAMS} : the deployed environment kernel parameters
\item \texttt{KADEPLOY\_DEPLOY\_PART} : deployment partition
\item \texttt{KADEPLOY\_BLOCK\_DEVICE} : the block device used in deployment
\item \texttt{KADEPLOY\_DEPLOY\_PART\_NUM} : the deployment parition number
\item \texttt{KADEPLOY\_SWAP\_PART\_NUM} : the swap partition number
\item \texttt{KADEPLOY\_PROD\_PART\_NUM} : the production partition number
\item \texttt{KADEPLOY\_TMP\_PART\_NUM} : the tmp partition number
\item \texttt{KADEPLOY\_ENV\_EXTRACTION\_DIR} : path where the environment tarball is extracted
\item \texttt{KADEPLOY\_TMP\_DIR} : a temporary directory (to be used for your scripts)
\item \texttt{KADEPLOY\_OS\_KIND} : the kind of operating system being deployed (the value of the \emph{environment\_kind} field of the environment description)
\item \texttt{KADEPLOY\_PART\_TYPE} : the MSDOS partition type of the deployment partition (the value of the \emph{fdisk\_type} field of the environment description)
\item \texttt{KADEPLOY\_FS\_TYPE} : the filesystem format of the deployment partition (the value of the \emph{filesystem} field of the environment description)
\end{itemize}

\texttt{Note}: This variables will also be substitued in your \texttt{destination} directory specification when you are using the \texttt{send} action.

Here is an example of a file that contains custom operations:
\begin{small}
\begin{verbatim}
    > cat ~/custom_ops.yml
    SetDeploymentEnvUntrusted:
      create_partition_table:
        substitute:
          - action: run
            name: my_partitioning
            file: partitioning.sh
            timeout: 16
            scattering: tree
    BroadcastEnvKastafior:
      send_environment:
        post-ops:
          - action: exec
            command: echo 'net.ipv4.ip_forward = 1' >> $KADEPLOY_ENV_EXTRACTION_DIR/etc/sysctl.conf
          - action: exec
            command: mkdir -p $KADEPLOY_ENV_EXTRACTION_DIR/mypath
          - action: send
            file: my_custom_file
            destination: $KADEPLOY_ENV_EXTRACTION_DIR/mypath
            retries: 1
            timeout: 24
            scattering: chain
\end{verbatim}
\end{small}

\paragraph{Use case 11 - expert usage - deploying a dd image on a block device}
\begin{verbatim}
> kadeploy3 -m griffon-1.nancy.grid5000.fr \
            -e ddgz_fulldisk_image \
            -b /dev/sda \
            -c 1
\end{verbatim}

For some specific purpose, you may want to deploy a dd image of an entire -partitioned- disk. To do this, you first have to create a ddgz image of the disk you want to deploy. Then you have to specify on which block device you want your image to be deployed with the \texttt{-b} option. You also need to tell on which partition the chainloaded reboot have to be performed with the \texttt{-c} option (typically a partition where a bootloader was installed).

\subsection{Kareboot}
Kareboot can be used by using the \texttt{kareboot3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kareboot3 -h
Usage: kareboot3 [options]
Contact: kadeploy3-users@lists.gforge.inria.fr

General options:
  -b, --block-device BLOCKDEVICE Specify the block device to use
  -c, --check-demolishing-tag    Check if some nodes was deployed with an environment that have the demolishing tag
  -e, --env-name ENVNAME         Name of the recorded environment
  -f, --file MACHINELIST         Files containing list of nodes (- means stdin)
  -k, --key [FILE]               Public key to copy in the root's authorized_keys, 
                                 if no argument is specified, use the authorized_keys
  -l, --reboot-level VALUE       Reboot level (soft, hard, very_hard)
  -m, --machine MACHINE          Reboot the given machines
      --multi-server             Activate the multi-server mode
  -n, --output-ko-nodes FILENAME File that will contain the nodes not correctly rebooted
  -o, --output-ok-nodes FILENAME File that will contain the nodes correctly rebooted
  -p, --partition-number NUMBER  Specify the partition number to use
  -r, --reboot-kind REBOOT_KIND  Specify the reboot kind (set_pxe, simple_reboot, 
                                 deploy_env, env_recorded)
  -u, --user USERNAME            Specify the user
  -v, --version                  Get the version
  -w, --set-pxe-profile FILE     Set the PXE profile (use with caution)
      --set-pxe-pattern FILE     Specify a file containing the substituation of a pattern for 
                                 each node in the PXE profile (the NODE_SINGULARITY pattern must
                                 be used in the PXE profile)
  -x, --upload-pxe-files FILES   Upload a list of files (file1,file2,file3) to the "tftp_images_path"
                                 directory. Those files will then be available in the KERNELS_DIR directory with the prefix FILES_PREFIX--
      --env-version NUMBER       Specify the environment version
      --no-wait                  Do not wait the end of the reboot
      --server STRING            Specify the Kadeploy server to use
  -V, --verbose-level VALUE      Verbose level between 0 to 5
      --reboot-classical-timeout V Overload the default timeout for classical reboots
\end{verbatim}
\end{small}

At least, Kareboot must be called with one node and a reboot kind. The nodes to reboot can be specified by using several \texttt{-m|--machine} options, or the \texttt{-f|--file} options (one node per line in the file), or a mix of both. The expected values for the \texttt{-r|--reboot-kind} are:
\begin{itemize}
\item \texttt{simple\_reboot}: perform a simple reboot of the nodes. Kareboot firstly tries to perform a soft reboot, then a hard reboot is performed and lastly a very hard reboot if it doesn't success before.
\item \texttt{set\_pxe}: modify the PXE profile with the one given with the \texttt{-w|--set-pxe-profile} options and perform a simple reboot.
\item \texttt{env\_recorded}: perform a reboot on an environment that is already deployed (for instance, the production environment on the production part). This operation must be used with the \texttt{-e} and \texttt{-p} options at least.
\item \texttt{deploy\_env}: perform a reboot on the deployment environment. This can be used with the \texttt{-k|--key} option.
\end{itemize}

Here are some basic examples:
\begin{verbatim}
> kareboot3 -m gdx-5.orsay.grid5000.fr -r simple_reboot
> kareboot3 -m gdx-[5-8].orsay.grid5000.fr -r simple_reboot
> cat nodefile|kareboot3 -f - -r simple_reboot
> kareboot3 -m gdx-5.orsay.grid5000.fr -r simple_reboot -o reboot_ok.txt \
                                                        -n reboot_ko.txt
> kareboot3 -f nodes -r set_pxe -w ~/customized_pxe_profile
> kareboot3 -f nodes -r set_pxe -w ~/customized_pxe_profile -l hard \
                                -x "~/custom_kernel,~/custom_initrd" \
                                --set-pxe-pattern ~/singularities (Cf. Kadeploy use case 6)
> kareboot3 -f nodes -r deploy_env -k .ssh/id_rsa
> kareboot3 -r env_recorded -e production_environment \
            -p 2 -u root -m gdx-5.orsay.grid5000.fr
> kareboot3 -r env_recorded -e production_environment \
            -p 2 -u root -m gdx-5.orsay.grid5000.fr \
            --no-wait
\end{verbatim}

Kareboot can be used to manage the demolishing environment. Typically, at the end of a reservation with deployment, the resource manager will perform a reboot on the production environment. By using the \texttt{-c|--check-demolishing-tag} option (for instance: \texttt{kareboot -f nodes -r env\_recorded -c}), Kareboot firstly checks if the deployed environment on the involved nodes is tagged like a demolishing environment. If the environment is considered as \textit{demolishing}, Kareboot does not perform a reboot and returns the \texttt{2} value. In this case, the recorded environment has been destroyed and should be deployed again. If the environment is not considered as \textit{demolishing}, the reboot is performed. If the nodes are correctly rebooted on the production environment, Kareboot returns the \texttt{0} value. Otherwise it returns the \texttt{1} value, what means that the recorded environment has been destroyed and that it should be deployed again.

In the Kaenv part you can find the way to remove the \textit{demolishing} tag of an environment.

Warning, if the \texttt{--no-wait} option is used, Kareboot won't wait the end of the reboot to exit. Thus, this option cannot be used with the \texttt{-o, --output-ok-nodes} and \texttt{-n, --output-ko-nodes} options.


\subsection{Kaenv}\label{sec:kaenv}
\subsubsection{Command line interface}
Kaenv can be used by using the \texttt{kaenv3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kaenv3 -h
Usage: kaenv3 [options]
Contact: kadeploy3-users@lists.grid5000.fr
General options:
  -a, --add ENVFILE                     Add an environment
  -d, --delete ENVNAME                  Delete an environment
  -l, --list                            List environments
  -m, --files-to-move FILES             Files to move (src1:dst1,src2:dst2,...)
  -p, --print ENVNAME                   Print an environment
  -s, --show-all-versions               Show all versions of an environment
  -t, --visibility-tag TAG              Set the visibility tag (private, shared, public)
  -u, --user USERNAME                   Specify the user
      --env-version NUMBER              Specify the version
      --server STRING                   Specify the Kadeploy server to use
Advanced options:
      --remove-demolishing-tag ENVNAME  Remove demolishing tag on an environment
      --set-visibility-tag ENVNAME      Set the visibility tag on an environment
      --update-image-md5 ENVNAME      Update the MD5 of the environment image
      --update-preinstall-md5 ENVNAME   Update the MD5 of the environment preinstall
      --update-postinstalls-md5 ENVNAME Update the MD5 of the environment postinstalls
      --move-files                      Move the files of the environment (for administrators only)
\end{verbatim}
\end{small}

We present now several use cases.
\paragraph{Use case 1 - list the environments}
\begin{verbatim}
> kaenv3 -l
\end{verbatim}
This command lists the environment that you have previously recorded, and the public environments.

\paragraph{Use case 2 - list the shared environments recorded by another user}
\begin{verbatim}
> kaenv3 -l -u johnsmith -s
\end{verbatim}
This command lists the environment of the user \textit{johnsmith}. If you use ``*'' as a user value, it lists the environments of all the users. Furthermore, the \texttt{-s|--show-all-versions} option is used to show all the versions of each environment. If this option is not specified, only the version is displayed.

\paragraph{Use case 3 - print an environment}
\begin{verbatim}
> kaenv3 -p FreeBSD --env-version 3 -u johnsmith
\end{verbatim}
This command lists prints the version \textit{3} of the environment \textit{FreeBSD} that belongs to \textit{johnsmith}. If no version number is given, the last version of the environment is printed. To print an environment you own, there is no need to use the \texttt{-u|--user} option.

\paragraph{Use case 4 - add an environment described in a file}
\begin{verbatim}
> kaenv3 -a ~/new_env.dsc
\end{verbatim}
This command adds the environment defined in the file \textit{~/new\_env.dsc}.

\paragraph{Use case 5 - add an environment described in an http file}
\begin{verbatim}
> kaenv3 -a http://www.grid5000.fr/pub/johnsmith/env.desc
\end{verbatim}
This command adds the environment defined in the file \textit{http://www.grid5000.fr/pub/johnsmith/env.desc}.

\paragraph{Use case 6 - delete an environment}
\begin{verbatim}
> kaenv3 -d FreeBSD --env-version 2
\end{verbatim}
This command deletes the version \textit{2} of the environment \textit{FreeBSD} from the environment database. If no version number is given, all the versions are deleted.

\paragraph{Use case 7 - remove the demolishing property of an environment}
\begin{verbatim}
> kaenv3 --remove-demolishing-tag FreeBSD --env-version 3
\end{verbatim}
This command remove the \textit{demolishing} tag of the version \textit{3} of the environment \textit{FreeBSD}. If no version number is given, the latest version of the environment is considered.

\paragraph{Use case 8 - update the tarball of an environment}
\begin{verbatim}
> kaenv3 --update-tarball-md5 sidx64-base
\end{verbatim}
This command is useful if you modify the tarball of the environment \textit{sidx64-base} without modifying the kernel or the initrd and if you do not want to record a new environment. Thus, it will update the MD5 of the tarball file. This operation is required if something change in the tarball, otherwise the environment will be unusable.

\paragraph{Use case 9 - update the postinstalls of an environment}
\begin{verbatim}
> kaenv3 --update-postinstalls-md5 sidx64-base
\end{verbatim}
This command does the same thing than the precedent one but it concerns the post-install files. This operation is required if something change in the post-install files, otherwise the environment will be unusable.

\paragraph{Use case 10 - define the visibility of an environment}
\begin{verbatim}
> kaenv3 --set-visibility-tag sidx64-base --env-version 3 -t private
\end{verbatim}
This command allows to define the environment \textit{sidx64-base} version 3 as a private environment. Note that the environment version is required and only the almighty environment users are allowed to define an environment as public.

\subsubsection{Environment description}\label{sec:env_desc}
The description of an environment is made with a YAML file (see section \ref{sec:yamlconf}).

Here is an example of an environment description:
\begin{small}
\begin{verbatim}
---
name: debian-xen
version: 3
description: https://www.grid5000.fr/index.php/Etch-x64-xen-1.0
author: John Smith
visibility: shared
image:
  file: /grid5000/debian-x64-xen-1.0.tgz
  kind: tar
  compression: gzip
preinstall:
  archive: /home/john/test/pre_install.tgz
  compression: gzip
  script: launch.sh
postinstalls:
- archive: /home/john/test/post_install1.tgz
  compression: gzip
  script: traitement.sh
- archive: /home/john/test/post_install2.tgz
  compression: gzip
  script: start.sh
boot:
  kernel: /boot/vmlinuz-2.6.18-6-xen-amd64
  kernel_params: console=tty0 console=ttyS1,38400n8
  initrd: /boot/initrd.img-2.6.18-6-xen-amd64
  hypervisor: /boot/xen-3.0.3-1-amd64.gz
  hypervisor_params: dom0_mem=1000000
partition_type: 0x83
filesystem: ext2
\end{verbatim}
\end{small}

Another (shorter) example:
\begin{small}
\begin{verbatim}
---
name: freebsd
version: 1
image:
  file: /grid5000/freebsd.ddgz
  kind: dd
  compression: gzip
\end{verbatim}
\end{small}

Explanation of the fields used in the environment description:
\begin{itemize}
  \item \yfield{name}{String} name of the environment. The spaces are allowed in the name but remember to use some quotes around it when you use Kadeploy or Kaenv.
  \item \yfieldd{version}{Integer}{1} the version of the environment
  \item \yfieldd{description}{String}{''} the description of the environment
  \item \yfieldd{author}{String}{''} the author of the environment
  \item \yfieldd{visibility}{String}{'shared'} define the visibility level of an environment. Three levels are available:
  \begin{itemize}
    \item \texttt{private}: only the owner of the environment can see and use it ;
    \item \texttt{shared}: the environment can be used by everybody but it must explicitly use with the owner name ; furtermore, it won't be listed unless the owner name is specified ;
    \item \texttt{public}: the environment can be used by everybody and it is listed without specifing its owner name.
  \end{itemize}
  \item \yfieldd{destructive}{Boolean}{false} specify that the environment is destructive
  \item \yfield{os}{String} kind of environment (expected values are \texttt{linux}, \texttt{xen} or \texttt{other}).
  \item \ypath{/image} the disk image of the environment
  \begin{itemize}
    \item \yfield{file}{String} the path to the disk image of the environment (can be local path or URL)
    \item \yfield{kind}{String} specify the kind of image (expected values are \texttt{tar} (a tarball archive of the environment) or \texttt{dd} (a dd image of the environment))
    \item \yfield{compression}{String} the compression of the disk image file (expected values are \texttt{gzip} or \texttt{bzip2})
  \end{itemize}
  \item \ypath{/preinstall} a pre-installation script that will be executed before the environment is sent and installed (useless unless the kind of image is \texttt{tar})
  \begin{itemize}
    \item \yfield{archive}{String} the path to the archive that contains the scripts (can be local path or URL)
    \item \yfield{compression}{String} the compression of archive (expected values are \texttt{gzip} or \texttt{bzip2})
    \item \yfieldd{script}{String}{none} the script to execute. For debug purpose, you can use the keyword \texttt{breakpoint} instead of a script. Thus, the file will be transferred, the deployment workflow will be stopped and you will be able to connect in the deployment environment to debug. Finally, the script value can be \textit{none} if no script must be launched. Warning, if the \texttt{preinstall} field is fulfilled, the entire \texttt{SetDeploymentEnv} step defined by the administrator will be bypassed. Refer to the~\ref{sec:custom-preinstall} part concerning build of a pre-install.
  \end{itemize}
  \item \ypath{/[postinstalls]} some post-installation script that will be executed after the environment is sent and installed (useless unless the kind of image is \texttt{tar})
  \begin{itemize}
    \item \yfield{archive}{String} the path to the archive that contains the scripts (can be local path or URL)
    \item \yfield{compression}{String} the compression of the archive (expected values are \texttt{gzip} or \texttt{bzip2})
    \item \yfieldd{script}{String}{none} the script to execute. For debug purpose, you can use the keyword \texttt{breakpoint} instead of a script. Thus, the file will be transferred, the deployment workflow will be stopped and you will be able to connect in the deployment environment to debug. Finally, the script value can be \textit{none} if no script must be launched. pre-install.
  \end{itemize}
  \item \ypath{/boot} information about the system that will be installed (useless unless the kind of image is \texttt{tar})
  \begin{itemize}
    \item \yfieldd{kernel}{String}{''} path of the kernel in the tarball.
    \item \yfieldd{kernel\_params}{String}{''} set of parameters that must be applied to the kernel for a correct boot
    \item \yfieldd{initrd}{String}{''} path of the initrd in the tarball.
    \item \yfieldd{hypervisor}{String}{''} path of the hypervisor in the tarball. This fields is only required for the Xen based environments
    \item \yfieldd{hypervisor\_params}{String}{''} set of parameters that must be applied to the hypervisor for a correct boot. This fields is only required for the Xen based environments
  \end{itemize}
  \item \yfieldd{partition\_type}{Integer}{0} the MS-DOS partition type, you can specify hexadecimal values using the prefix \texttt{0x}. For sample, \texttt{0x83} or \texttt{131} for Linux, \texttt{0xa5} for FreeBSD, ... (useless unless the kind of image is \texttt{tar})
  \item \yfieldd{filesystem}{String}{''} type of filesystem wished on the deployment partition. It must be known by the mkfs command (useless unless the kind of image is \texttt{tar})
\end{itemize}

\subsection{Kaconsole}\label{sec:kaconsole}
Karights can be used by using the \texttt{kaconsole} command. It has only one use case that is opening a console on a given node, for instance:
\begin{verbatim}
> kaconsole3 -m gdx-25.orsay.grid5000.fr
\end{verbatim}

Kaconsole can't be used on a node on which a user doesn't have the deployment rights. Furthermore, as soon as the deployments rights are revoked for a user, ever open console is automatically closed.

\subsection{Kastat}\label{sec:kastat}
Kastat can be used by using the \texttt{kastat3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kastat3 -h
Usage: kastat3 [options]
Contact: kadeploy3-users@lists.grid5000.fr
General options:
  -a, --list-min-retries NB        Print the statistics about the nodes that need several attempts
  -b, --list-failure-rate          Print the failure rate for the nodes
  -c, --list-min-failure-rate RATE Print the nodes which have a minimum failure-rate of 
                                   RATE (0 <= RATE <= 100
  -d, --list-all                   Print all the information
  -f, --field FIELD                Only print the given fields (user,hostname,step1,step2,step3,
                                                           timeout_step1,timeout_step2,timeout_step3,
                                                           retry_step1,retry_step2,retry_step3,
                                                           start,
                                                           step1_duration,step2_duration,step3_duration,
                                                           env,md5,success,error)
  -m, --machine MACHINE            Only print information about the given machines
  -s, --step STEP                  Applies the retry filter on the given steps (1, 2 or 3)
  -v, --version                    Get the version
  -x, --date-min DATE              Get the stats from this date (yyyy:mm:dd:hh:mm:ss)
  -y, --date-max DATE              Get the stats to this date
      --server STRING              Specify the Kadeploy server to use
\end{verbatim}
\end{small}

We present now the use cases. Note that all the commands can be filtered with a period by using the \texttt{-x|--date-min} and \texttt{-y|--date-max} options.
\paragraph{Use case 1 - get the information about the deployments performed on a node}
\begin{verbatim}
> kastat3 -d -m gdx-25.orsay.grid5000.fr
\end{verbatim}
This command prints all the deployment performed on the node \textit{gdx-25.orsay.grid5000.fr}.

\paragraph{Use case 2 - get the information about deployments performed on a range of node}
\begin{verbatim}
> kastat3 -d -m gdx-[25-130].orsay.grid5000.fr
\end{verbatim}
This command prints all the deployment performed on the nodes \textit{gdx-25.orsay.grid5000.fr}, \textit{gdx-26.orsay.grid5000.fr}, ..., \textit{gdx-130.orsay.grid5000.fr}.

\paragraph{Use case 3 - print only a subset of the information about the deployments performed}
\begin{verbatim}
> kastat3 -d -f hostname -f env -f success
\end{verbatim}
This command prints all the deployment performed. Because the \texttt{-f|--field} option is used, only the fields \textit{hostname}, \textit{env}, and \textit{success} are printed. If the option \texttt{-f|--field} is not used, all the fields are printed.

\paragraph{Use case 4 - print the failure rate about the nodes wrt the deployments that occurs between two dates}
\begin{verbatim}
> kastat3 -b -x 2009:02:12:08:00:00 -y 2009:02:13:08:00:00
\end{verbatim}
This command prints the failure rate of all the nodes (at least deployed one time) during the period between the 2009/02/12 - 8h00 and the 2009/02/13 - 8h00. The \texttt{-x|--date-min} and \texttt{-y|--date-max} options can be used separately or can be omitted.

\paragraph{Use case 5 - print the information about the nodes that have at least a given failure rate}
\begin{verbatim}
> kastat3 -c 25 -x 2009:02:12:08:00:00
\end{verbatim}
This command prints the nodes that have a failure rate of at least 25\% from the 2009/02/12 - 8h00.

\paragraph{Use case 6 - print the information about the nodes that require several retries to deploy correctly}
\begin{verbatim}
> kastat3 -a 3 -s 1
\end{verbatim}
This command prints the information about the deployments that requires at least 3 retries in the macro-step 1. If the \texttt{-s|--step} option is not set, the information about the deployments that requires at least 3 retries in any macro-step are printed.


\subsection{Kanodes}\label{sec:kanodes}
Kanodes can be used by using the \texttt{kanodes3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kanodes3 -h
Usage: kanodes3 [options]
Contact: kadeploy3-users@lists.grid5000.fr
General options:
  -d, --get-deploy-state       Get the deploy state of the nodes
  -f, --file MACHINELIST       Only print information about the given machines (- means stdin)
  -m, --machine MACHINE        Only print information about the given machines
  -v, --version                Get the version
  -w, --workflow-id WID        Specify a workflow id (this is use with the get_yaml_dump 
                               operation. If no wid is specified, the information of all
                               the running worklfows will be dumped
  -y, --get-yaml-dump          Get the yaml dump
      --server STRING          Specify the Kadeploy server to use
\end{verbatim}
\end{small}

We present now the use cases.
\paragraph{Use case 1 - print the deployment state of the nodes}
\begin{verbatim}
> kanodes3 -d
\end{verbatim}
This command prints the global state of all the nodes managed by a Kadeploy server. The output is as follows 1,2,3,4,5,6, where :
\begin{itemize}
\item 1 is the hostname ;
\item 2 is the deployment state of the node (prod\_env, deployed, deploy\_failed, aborted) ;
\item 3 is the username who launched the last deployment ;
\item 4 is the environment name ;
\item 5 is the environment version ;
\item 6 is the environment owner.
\end{itemize}

\paragraph{Use case 2 - print the deployment state of some nodes}
\begin{verbatim}
> kanodes3 -d -m gdx-25.orsay.grid5000.fr -m netgdx-[1-30].orsay.grid5000.fr -f machine_file
\end{verbatim}
This command prints the global state of the node \textit{gdx-25.orsay.grid5000.fr} the nodes \textit{netgdx-1.orsay.grid5000.fr}, \textit{netgdx-2.orsay.grid5000.fr}, ..., \textit{netgdx-30.orsay.grid5000.fr} and of the nodes listed in the file \texttt{machine\_file}.

\paragraph{Use case 3 - get information about all the current deployment workflows}
\begin{verbatim}
> kanodes3 -y
\end{verbatim}
This command prints a YAML output of the deployment state of all the nodes currently in deployment. On the YAML output, the nodes are sorted according to the deployment workflow they belong to.

\paragraph{Use case 4 - get information about a specific deployment workflows}
\begin{verbatim}
> kanodes3 -y -w 78
\end{verbatim}
This command prints a YAML output of the deployment state of all the nodes currently in the deployment number 78. The deployment number, or workflow id, can be obtained thanks to a Kadeploy option.

\subsection{Kapower}\label{sec:kapower}
Kapower can be used by using the \texttt{kapower3} command. The CLI looks like this:
\begin{small}
\begin{verbatim}
> kapower3 -h
Usage: kapower3 [options]
Contact: kadeploy3-users@lists.gforge.inria.fr
General options:
  -d, --debug-mode               Activate the debug mode
  -f, --file MACHINELIST         Files containing list of nodes (- means stdin)
  -l, --level VALUE              Level (soft, hard, very_hard)
  -m, --machine MACHINE          Operate on the given machines
      --multi-server             Activate the multi-server mode
  -n, --output-ko-nodes FILENAME File that will contain the nodes on which 
                                 the operation has not been correctly performed
  -o, --output-ok-nodes FILENAME File that will contain the nodes on which the
                                 operation has been correctly performed
      --off                      Shutdown the nodes
      --on                       Power on the nodes
      --status                   Get the status of the nodes
  -v, --version                  Get the version
      --no-wait                  Do not wait the end of the power operation
      --server STRING            Specify the Kadeploy server to use
  -V, --verbose-level VALUE      Verbose level between 0 to 5
\end{verbatim}
\end{small}

\paragraph{Use case 1 - print the power status of some nodes}
\begin{verbatim}
> kapower3 --status -m gdx-[25-35].orsay.grid5000.fr -o nodes_up -n nodes_down
\end{verbatim}
This command print the power status of the nodes \textit{gdx-25.orsay.grid5000.fr} to \textit{gdx-35.orsay.grid5000.fr}. Furthermore, the list of the powered up nodes is stored in \texttt{nodes\_up} and the list of the powered off nodes is stored in \texttt{nodes\_down}.

\paragraph{Use case 2 - power off some nodes}
\begin{verbatim}
> kapower3 --off -f machine_file --server lille
\end{verbatim}
This command powers off the nodes nodes contained in the \texttt{machine\_file} file. Since the \texttt{--server} is used, the nodes of a distant site are concerned by the operation ; in this example, the \texttt{lille} site is concerned.

\paragraph{Use case 3 - power on some nodes}
\begin{verbatim}
> kapower3 --on -m gdx-25.orsay.grid5000.fr --no-wait
\end{verbatim}
This command powers on the node \textit{gdx-25.orsay.grid5000.fr} without waiting the end of the operation to return.

\paragraph{Note for the administrators}
While using the \texttt{--no-wait} option, Kapower add the \texttt{--no-wait} value to the command line used for the given operation. Thus the underlying power management tool must be able to handle this option if this Kapower option is required.


\subsection{Karights}\label{sec:karights}
Karights can be used by using the \texttt{karights3} command (it is designed for administrators in order to allow users to perform deployments). The CLI looks like this:
\begin{small}
\begin{verbatim}
> karights3 -h
Usage: karights3 [options]
Contact: kadeploy3-users@lists.grid5000.fr
General options:
  -a, --add                    Add some rights to a user
  -d, --delete                 Delete some rights to a user
  -f, --file FILE              Machine file (- means stdin)
  -m, --machine MACHINE        Include the machine in the operation
  -o, --overwrite-rights       Overwrite existing rights
  -p, --part PARTNAME          Include the partition in the operation
  -s, --show-rights            Show the rights for a given user
  -u, --user USERNAME          Specify the user
  -v, --version                Get the version
      --server STRING          Specify the Kadeploy server to use
\end{verbatim}
\end{small}

We present now the use cases.
\paragraph{Use case 1 - give some rights to a user on a node}
\begin{verbatim}
> karights3 -a -m gdx-25.orsay.grid5000.fr -p /dev/sda3 -u johnsmith
\end{verbatim}
This command gives some rights for a given user.

\paragraph{Use case 1 - give some rights to a user on several nodes}
\begin{verbatim}
> karights3 -a -m gdx-[25-32].orsay.grid5000.fr -p /dev/sda3 -u johnsmith
\end{verbatim}
This command gives some rights for a given user on a range of nodes.

\paragraph{Use case 3 - give all the rights to a user on all the nodes}
\begin{verbatim}
> karights3 -a -m "*" -p "*" -u root
\end{verbatim}
This command gives all the rights on all the nodes to the user \textit{root}.

\paragraph{Use case 4 - give some rights on a node and remove existing ones}
\begin{verbatim}
> karights3 -a -m gdx-25.orsay.grid5000.fr -p /dev/sda3 -u johnsmith -o
\end{verbatim}
This command gives some rights for a given user. Furthermore, if some rights (excepted those specified with *) were previously given on the node \textit{gdx-25.orsay.grid5000.fr}, they are deleted.

\paragraph{Use case 5 - remove som rights}
\begin{verbatim}
> karights3 -d -m gdx-25.orsay.grid5000.fr -p /dev/sda3 -u johnsmith
\end{verbatim}
This command removes some rights for a given user.

\paragraph{Use case 6 - show the rights of a user}
\begin{verbatim}
> karights3 -s -u johnsmith
\end{verbatim}
This command shows the rights given to user.


\section{What you should know if you want to do kernel development on deployed nodes}
Kernel development implies to know what Kadeploy do concerning the boot of the deployed environments.

\subsection{Kadeploy 3 behavior}
Kadeploy 3 has a different behavior depending on the kind of deployed environment. Reminder: the kind of environment is defined in the environment description.

\subsubsection{Linux environments}
On a \emph{Linux} environment, Kadeploy 3 automatically installs the Grub 2 bootloader on the deployed partition once the tarball is broadcasted. Then it modifies the PXE profile of the concerned nodes in order to ask the chainload on the deployed partition. This is performed thanks to pxelinux and the comboot chain.c32.

\subsubsection{Xen environments}
On a \emph{Xen} environment, Kadeploy 3 doesn't install the Grub 2 bootloader since Grub 2 there are some known issues when booting a Xen Dom0 with Grub 2. Thus Kadeploy 3 uses the old method that consists in booting the nodes in a pure PXE fashion. To do that, Kadeploy extracts the kernel, initrd and hypervisor files from the environment tarball and modifies the PXE profile of the concerned nodes in order to ask their in pure PXE. This is performed thanks to pxelinux and the comboot mboot.c32.

\subsubsection{Other environments}
On an \emph{Other} environment, Kadeploy 3 assumes that a bootloader is already installed on the partition since a full partition image (dd.gz image) has been copied. Thus, it only modifies the PXE profile of the concerned nodes in order to ask the chainload on the deployed partition, like in the \emph{Linux} case.

\subsection{Tips to simply use your new kernel}
If you do kernel development on the deployed nodes, you will probably want to update you kernel without recording a new image and redeploying it to save time, especially to perform small tests.

\subsubsection{Linux environments}
On a \emph{Linux} environment, after having updated your kernel/initrd, 2 cases are imaginable:
\begin{enumerate}
\item your kernel/initrd have the same name, so you can reboot the node without modifying anything.
\item your kernel/initrd have a new name, so you will have to update the grub configuration file (\texttt{/boot/grub/grub.cfg}) of your node in order to allow grub to select the new kernel and then you can reboot the node.
\end{enumerate}

\subsubsection{Xen environments}
On a \emph{Xen} environment, the things are a little bit more complicated. As far as the kernel/initrd/hypervisor are extracted by Kadeploy in a dedicated cache, changing them on the deployed nodes won't have any effect for the next reboot. So you have to use a feature of Kareboot that allows to reboot a node after having changed the PXE profile of the node. For instance:
\begin{verbatim}
> kareboot3 -m gdx-25.orsay.grid5000.fr -r set_pxe -w ~/pxe_profile_xen \
            -x "~/custom_kernel,~/custom_initrd,~/custom_hypervisor"
\end{verbatim}
Kadeploy has the same feature, so please refer to the use case about \textit{specific PXE profile} for more information.

\subsubsection{Other environments}
On an \emph{Other} environment, you eventually have to update your bootloader in order to boot on the new kernel.

\section{Migrate your Kadeploy 2.1.x environment}
Migrating your environments from Kadeploy 2.1.x is quite easy. Please refer to the~\ref{sec:env_desc} part to get the full information about the environment description with Kadeploy 3.

\subsubsection{Differences}
The fields used in the previous descriptions are similar. This following fields are exactly the same: \texttt{name}, \texttt{version}, \texttt{description}, \texttt{author}, \texttt{fdisktype}, and \texttt{filesystem}. You just have to replace the \texttt{=} character with \texttt{:} for these fields.
Then, the old \texttt{filebase} and \texttt{filesite} have been modified and renamed in \texttt{tarball} and \texttt{postinstall}.

Kadeploy 3 considers three kinds of environments: \textit{linux}, \textit{xen}, and \textit{other}. The environment kind must be specified with the field \texttt{environment\_kind}.
\begin{itemize}
\item If you choose the \textit{linux} kind, you can fill the new \texttt{kernel} field by using the old \texttt{kernelpath} field. This is the same thing with the new \texttt{initrd} field where you can use the old \texttt{initrdpath}. The new \texttt{kernel\_params} field can be filled with the old \texttt{kernelparam}.
\item If you choose the \textit{xen}, you must use the fields of a \textit{linux} environment and the new \texttt{hypervisor} and \texttt{hypervisor\_params}. You do not have to specify anymore the use of mboot.c32, this is automatically handled by Kadeploy 3.
\item If you choose the \textit{other} kind (typically for OS like FreeBSD), you can fill the \texttt{kernel}, \texttt{kernel\_params} and \texttt{initrd} with any value.
\end{itemize}

The field \texttt{part} has been added to allow the users to specify a default deployment partition for their environment. The expected value must be an existing block device like \texttt{/dev/sda3}.

\subsubsection{Automatic translation}
A small script named \texttt{env\_migrate} has been written to ease the translation of the old Kadeploy environment. The CLI looks like this:

\begin{small}
\begin{verbatim}
> kaenv2to3 -h
Usage: kaenv2to3 [options]
Contact: kadeploy3-users@lists.grid5000.fr

General options:
  -e, --env-name NAME          Environment name
  -f, --env-file FILE          Environment file
  -k, --env-kind KIND          Environment kind (linux|xen|other)
\end{verbatim}
\end{small}

To use \texttt{kaenv2to3}, you have to choose the kind of environment you wish to migrate and you have to choose the environment. The choice can be made in two ways:
\begin{itemize}
\item choosing the environment from its name in the old version of Kadeploy (like it can be seen with the kaenvironments output) ;
\item choosing the environment from a file that contains the description in the old format.
\end{itemize}

Here are two examples:
\begin{small}
\begin{verbatim}
> kaenv2to3 -e envname_in_kaenvironments_db -k linux
> kaenv2to3 -f envfile_in_2_1_x_format.dsc -k xen
\end{verbatim}
\end{small}

If everything went right, the output of \texttt{kaenv2to3} shows the description in the new format. You can redirect this output to a file and use this file as an input for \texttt{kaenv}.

\section{Environment variables in the pre- and post-install context}
When writing a script for an admin pre-install, an admin post-install and a user post-install, you can use the following environment variables :
\begin{itemize}
\item \texttt{KADEPLOY\_CLUSTER} : cluster on which the pre/post install is launched
\item \texttt{KADEPLOY\_ENV} : environment deployed
\item \texttt{KADEPLOY\_ENV\_KERNEL} : the path to the kernel file inside the deployed environment directory
\item \texttt{KADEPLOY\_ENV\_INITRD} : the path to the initrd file inside the deployed environment directory
\item \texttt{KADEPLOY\_ENV\_KERNEL\_PARAMS} : the deployed environment kernel parameters
\item \texttt{KADEPLOY\_DEPLOY\_PART} : deployment partition
\item \texttt{KADEPLOY\_BLOCK\_DEVICE} : the block device used in deployment
\item \texttt{KADEPLOY\_DEPLOY\_PART\_NUM} : the deployment parition number
\item \texttt{KADEPLOY\_SWAP\_PART\_NUM} : the swap partition number
\item \texttt{KADEPLOY\_PROD\_PART\_NUM} : the production partition number
\item \texttt{KADEPLOY\_TMP\_PART\_NUM} : the tmp partition number
\item \texttt{KADEPLOY\_ENV\_EXTRACTION\_DIR} : path where the environment tarball is extracted
\item \texttt{KADEPLOY\_PREPOST\_EXTRACTION\_DIR} : path where the pre/post tarball are extracted
\item \texttt{KADEPLOY\_TMP\_DIR} : a temporary directory (to be used for your scripts)
\item \texttt{KADEPLOY\_OS\_KIND} : the kind of operating system being deployed (the value of the \emph{environment\_kind} field of the environment description)
\item \texttt{KADEPLOY\_PART\_TYPE} : the MSDOS partition type of the deployment partition (the value of the \emph{fdisk\_type} field of the environment description)
\item \texttt{KADEPLOY\_FS\_TYPE} : the filesystem format of the deployment partition (the value of the \emph{filesystem} field of the environment description)
\end{itemize}

\section{Build a custom pre-install}\label{sec:custom-preinstall}
The goal of the pre-install in the Kadeploy workflow is to prepare the disk of the nodes before the copy of the environment. It can include:
\begin{itemize}
\item setting disk parameters (with hdparm for instance) ;
\item partitioning the disk (with fdisk or parted) ;
\item formating the deployment and the \texttt{/tmp} partition ;
\item mounting partition(s).
\end{itemize}

To setup a custom pre-install you first have to create an archive that contains your scripts. After that you have to tell kadeploy which script of your archive has to be executed, this is done by specifying the \texttt{preinstall} field in your environment description file (see section \ref{sec:env_desc}). Please be careful to use relative paths in your scripts since you dont know where they will be uncompressed.

You can do want you want in the pre-install but you must know that Kadeploy will extract the environment in the directory defined by the \ypath{/environments/deployment/extraction\_dir} field of the general configuration file. Commonly, this directory is \texttt{/mnt/dest}. Thus, you have to mount all the partitions you need in this directory. If you wish to deploy the environment onto several partitions, you can use for instance the following map:
\begin{itemize}
\item /dev/sda3 $\mapsto$ /mnt/dest
\item /dev/sda4 $\mapsto$ /mnt/dest/var
\item /dev/sda5 $\mapsto$ /mnt/dest/usr
\item /dev/sda6 $\mapsto$ /mnt/dest/tmp
\end{itemize}

If you choose to mount more than one partition in the pre-install, remember to umount all the partitions excepted the one mounted on \ypath{/environments/deployment/extraction\_dir} (\texttt{/mnt/dest} in principle) in the post-install step. Indeed, the common Kadeploy workflow will automatically umount the partition mounted on \ypath{/environments/deployment/extraction\_dir}. Thus, if other partitions are mounted, the umount will fail.


\section{Do a custom partitioning}\label{sec:custom-partitioning}
To perform a custom partitioning, you can use a substitute custom operation. There is two ways to setup this kind of operation: in the cluster-specific configuration file (Administrator) or using the Kadeploy3 client (User).

\subsection{Custom partitioning with cluster-specific configuration}\
The setting to modify in the cluster-specific configuration file (see section \ref{sec:specific_config}) is \ypath{/automata/macrosteps/[SetDeploymentEnv]/[microsteps]/format\_deploy\_part/[substitute]}.

Here is a sample of the configuration file setting:
\begin{small}
\begin{verbatim}
    ...
    automata:
      macrosteps:
        SetDeploymentEnv:
          - type: Untrusted
            timeout: 200
            microsteps:
              - name: format_deploy_part
                substitute:
                  - action: send
                    file: partition_file
                    destination: /
                    timeout: 10
                    scattering: chain
                  - action: exec
                    command: cat /partition_file | fdisk
                    retries: 1
\end{verbatim}
\end{small}

\subsection{Custom partitioning with Kadeploy3 client}
You can use the Kadeploy3 client's option \emph{--set-custom-operations} (see \ref{sec:kadeploy_client}) to setup custom micro-step operations.

The field to configure is the field \ypath{/SetDeploymentEnv/create\_partition\_table/[substitute]}.

Be careful to use the same partitioning scheme than the one which is configured by default on the server in order for the deployment process to perform properly.

If you want to change the partitioning scheme, you'll have to substitute the microsteps format\_deploy\_part, mount\_deploy\_part, umount\_deploy\_part, format\_swap\_part and format\_tmp\_part in order to mount and format the right partitions during the deployment.

Here is a sample of the client command:
\begin{verbatim}
    > kadeploy3 -m griffon-1.nancy.grid5000.fr \
                -e squeeze-x64-base \
                --set-custom-operations ~/custom_ops.yml
\end{verbatim}

Here is a sample of a the custom operations file:
\begin{small}
\begin{verbatim}
    > cat ~/custom_ops.yml
    SetDeploymentEnvUntrusted:
      create_partition_table:
        substitute:
          - action: run
            name: my_custom_partitioning
            file: partitioning.sh
\end{verbatim}
\end{small}


\end{document}
