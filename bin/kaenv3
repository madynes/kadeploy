#!/usr/bin/ruby -w

# Kadeploy 3.1
# Copyright (c) by INRIA, Emmanuel Jeanvoine - 2008-2011
# CECILL License V2 - http://www.cecill.info
# For details on use and redistribution please refer to License.txt

$kadeploy_libs=ENV['KADEPLOY3_LIBS']||'/usr/local/kadeploy3/src/lib'

$:.unshift($kadeploy_libs)

require 'optparse'
require 'client'

Signal.trap("INT") do
  puts "\nSIGINT trapped, let's clean everything ..."
  KaenvClient.kill() rescue nil
  exit!(1)
end

class KaenvClient < Client
  def self.operation()
    'Environment management'
  end

  def self.load_options()
    {
      :environment => {},
      :operation => String.new,
      :env_desc => String.new,
      :env_name => String.new,
      :user => nil,
      :true_user => USER, #By default, we use the current user
      :visibility_tag => String.new,
      :show_all_version => false,
      :version => nil,
      :files_to_move => Array.new,
      :get_version => false,
      :chosen_server => String.new,
      :servers => load_configfile(),
      :kadeploy_server => String.new,
      :kadeploy_server_port => String.new,
    }
  end

  def self.parse_options()
    options = load_options()
    opts = OptionParser::new do |opt|
      opt.summary_indent = "  "
      opt.summary_width = 38
      opt.banner = "Usage: kaenv3 [options]"
      opt.separator "Contact: #{CONTACT_EMAIL}"
      opt.separator ""
      opt.separator "General options:"
      opt.on("-a", "--add ENVFILE", "Add an environment") { |f|
        if tmp = load_envfile(f)
          options[:load_env_desc] = tmp
          options[:load_env_file] = f
          options[:operation] = "add"
        else
          return false
        end
      }
      opt.on("-d", "--delete ENVNAME", "Delete an environment") { |n|
        options[:env_name] = n
        options[:operation] = "delete"
      }
      opt.on("-l", "--list", "List environments") {
        options[:operation] = "list"
      }
      opt.on("-m", "--files-to-move FILES", "Files to move (src1:dst1,src2:dst2,...)") { |f|
        if /\A.+:.+(,.+:.+)*\Z/ =~f then
          f.split(",").each { |src_dst|
            options[:files_to_move].push({"src"=>src_dst.split(":")[0],"dest"=>src_dst.split(":")[1]})
          }
        else
          error("Invalid synthax for files to move")
          return false
        end
      }
      opt.on("-p", "--print ENVNAME", "Print an environment") { |n|
        options[:env_name] = n
        options[:operation] = "print"
      }
      opt.on("-s", "--show-all-versions", "Show all versions of an environment") {
        options[:show_all_version] = true
      }
      opt.on("-t", "--visibility-tag TAG", "Set the visibility tag (private, shared, public)") { |v|
        if /\A(private|shared|public)\Z/ =~ v then
          options[:visibility_tag] = v
        else
          error("Invalid visibility tag")
        end
      }
      opt.on("-u", "--user USERNAME", "Specify the user") { |u|
        if /\A(\w+|\*)\Z/ =~ u then
          options[:user] = u
        else
          error("Invalid user name")
          return false
        end
      }
      opt.on("-v", "--version", "Get the version") {
        options[:get_version] = true
      }
      opt.on("--env-version NUMBER", "Specify the version") { |v|
        if /\A\d+\Z/ =~ v then
          options[:version] = v
        else
          error("Invalid version number")
          return false
        end
      }
      opt.on("--server STRING", "Specify the Kadeploy server to use") { |s|
        options[:chosen_server] = s
      }
      opt.separator "Advanced options:"
      opt.on("--remove-demolishing-tag ENVNAME", "Remove demolishing tag on an environment") { |n|
        options[:env_name] = n
        options[:operation] = "remove-demolishing-tag"
      }
      opt.on("--set-visibility-tag ENVNAME", "Set the visibility tag on an environment") { |n|
        options[:env_name] = n
        options[:operation] = "set-visibility-tag"
      }
      opt.on("--update-image-md5 ENVNAME", "Update the MD5 of the environment image") { |n|
        options[:env_name] = n
        options[:operation] = "update-tarball-md5"
      }
      opt.on("--update-preinstall-md5 ENVNAME", "Update the MD5 of the environment preinstall") { |n|
        options[:env_name] = n
        options[:operation] = "update-preinstall-md5"
      }
      opt.on("--update-postinstalls-md5 ENVNAME", "Update the MD5 of the environment postinstalls") { |n|
        options[:env_name] = n
        options[:operation] = "update-postinstalls-md5"
      }
      opt.on("--move-files", "Move the files of the environments (for administrators only)") { |n|
        options[:operation] = "move-files"
      }
    end
    @opts = opts
    begin
      opts.parse!(ARGV)
    rescue
      error("Option parsing error: #{$!}")
      return false
    end

    options[:chosen_server] = options[:servers]['default'] if options[:chosen_server].empty?
    options[:kadeploy_server] = options[:servers][options[:chosen_server]][0]
    options[:kadeploy_server_port] = options[:servers][options[:chosen_server]][1]

    return options
  end

  def self.check_options(options)
    case options[:operation]
    when 'add'
      if options[:load_env_desc].empty?
        error("You must choose a file that contains the environment description")
        return false
      end
    when 'list'

    when 'delete', 'print', 'update-tarball-md5', 'update-preinstall-md5', 'update-postinstalls-md5', 'remove-demolishing-tag'
      if exec_specific.env_name.empty?
        error("You must choose an environment")
        return false
      end
    when 'set-visibility-tag'
      if exec_specific.env_name.empty?
        error("You must choose an environment")
        return false
      end
      if exec_specific.visibility_tag.empty?
        error("You must define the visibility value")
        return false
      end
    when 'move-files'
      if (exec_specific.files_to_move.empty?) then
        error("You must define some files to move")
        return false
      end
    else
      error("You must choose an operation")
      return false
    end

    return true
  end

  def run(options)
  end
end

if __FILE__ == $0
  KaenvClient.launch()
end
